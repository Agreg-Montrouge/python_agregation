!function(e){function t(t){for(var i,s,a=t[0],c=t[1],u=t[2],l=0,d=[];l<a.length;l++)s=a[l],Object.prototype.hasOwnProperty.call(r,s)&&r[s]&&d.push(r[s][0]),r[s]=0;for(i in c)Object.prototype.hasOwnProperty.call(c,i)&&(e[i]=c[i]);for(h&&h(t);d.length;)d.shift()();return o.push.apply(o,u||[]),n()}function n(){for(var e,t=0;t<o.length;t++){for(var n=o[t],i=!0,a=1;a<n.length;a++){var c=n[a];0!==r[c]&&(i=!1)}i&&(o.splice(t--,1),e=s(s.s=n[0]))}return e}var i={},r={62:0},o=[];function s(t){if(i[t])return i[t].exports;var n=i[t]={i:t,l:!1,exports:{}};return e[t].call(n.exports,n,n.exports,s),n.l=!0,n.exports}s.m=e,s.c=i,s.d=function(e,t,n){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(e,t){if(1&t&&(e=s(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(s.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)s.d(n,i,function(t){return e[t]}.bind(null,i));return n},s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="";var a=window.webpackJsonp=window.webpackJsonp||[],c=a.push.bind(a);a.push=t,a=a.slice();for(var u=0;u<a.length;u++)t(a[u]);var h=c;o.push([1161,2]),n()}({1161:function(e,t,n){e.exports=n(1192)},1192:function(e,t,n){"use strict";n.r(t);var i,r=window.__CORE__;!function(e){e[e.IDLE=0]="IDLE",e[e.LOAD=1]="LOAD",e[e.READY=2]="READY"}(i||(i={}));var o=n(15);function s(e){return(s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function a(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function c(e,t){return(c=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function u(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,i=d(e);if(t){var r=d(this).constructor;n=Reflect.construct(i,arguments,r)}else n=i.apply(this,arguments);return h(this,n)}}function h(e,t){if(t&&("object"===s(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return l(e)}function l(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function d(e){return(d=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function f(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var v={where:function(e){return["Attach"===e.type]},to:"DOCUMENT_ATTACH"},p={IDLE:[{where:function(e){return["Setup"===e.type]},to:"SETUP"}],SETUP:[v],CRASHED:[v],DOCUMENT_ATTACH:[{where:function(e){return["Dettach"===e.type]},to:"DOCUMENT_DETTACH"},{where:function(e){return["Error"===e.type]},to:"CRASHED",error:!0}],DOCUMENT_DETTACH:[v]},m=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&c(e,t)}(o,e);var t,n,i,r=u(o);function o(e){var t;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,o),f(l(t=r.call(this,"IDLE",p)),"owner",void 0),f(l(t),"onSetup",(function(e){t.owner.doAttachToWorkspace(e.workspace)})),f(l(t),"onAttach",(function(e){t.owner.doAttachDocument(e.document)})),f(l(t),"onDettach",(function(){t.owner.doDettachDocument()})),t.on("SETUP",t.onSetup),t.on("DOCUMENT_ATTACH",t.onAttach),t.on("DOCUMENT_DETTACH",t.onDettach),t.owner=e,t}return t=o,(n=[{key:"setup",value:function(e){this.dispatch({type:"Setup",workspace:e})}},{key:"attachDocument",value:function(e){this.dispatch({type:"Attach",document:e})}},{key:"dettachDocument",value:function(){this.dispatch({type:"Dettach"})}}])&&a(t.prototype,n),i&&a(t,i),Object.defineProperty(t,"prototype",{writable:!1}),o}(o.a);function g(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function y(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var b=function(){function e(t){var n=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),y(this,"workspace",void 0),y(this,"size",{width:0,height:0}),y(this,"displayed",!1),y(this,"ee",void 0),y(this,"onWindowResize",(function(){var e=n.size.width,t=n.size.height;if(0===n.workspace.clientHeight||0===n.workspace.clientWidth)n.displayed=!1,n.emit("hidden");else{if(n.size.width=n.workspace.clientWidth,n.size.height=n.workspace.clientHeight,!n.displayed&&(n.displayed=!0,n.emit("shown"),t===n.size.height&&e===n.size.width))return;0!==e&&n.emit("didSizeChange",n.size.width/e)}})),this.ee=window.__CORE__.createEventEmmiterInstance(),this.workspace=t,this.initEvents(t),(this.workspace.clientHeight>0||this.workspace.clientWidth>0)&&(this.size.height=this.workspace.clientHeight,this.size.width=this.workspace.clientWidth,this.displayed=!0)}var t,n,i;return t=e,(n=[{key:"once",value:function(e,t){return this.ee.once(e,t)}},{key:"on",value:function(e,t){return this.ee.on(e,t)}},{key:"off",value:function(e,t){return this.ee.off(e,t)}},{key:"eventNames",value:function(){return this.ee.eventNames()}},{key:"emit",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];return this.ee.emit(e,t)}},{key:"destroy",value:function(){this.workspace&&(this.releaseEvents(this.workspace),this.workspace=null)}},{key:"initEvents",value:function(e){e&&window.addEventListener("resize",this.onWindowResize)}},{key:"releaseEvents",value:function(e){e&&window.removeEventListener("resize",this.onWindowResize)}}])&&g(t.prototype,n),i&&g(t,i),Object.defineProperty(t,"prototype",{writable:!1}),e}();function w(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function S(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var E=function(){function e(t,n){var i=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),S(this,"styleElement",void 0),S(this,"channels",void 0),S(this,"staticStyles",void 0),S(this,"currentChannel",void 0),S(this,"currentVariant",void 0),S(this,"destroy",(function(){r.bus.off("Variants:changed",i.updateVariant),r.bus.off("SchEngine:didDocumentAttach",i.setChannel),r.bus.off("SchEngine:didDocumentDettach",i.destroy)})),S(this,"updateVariant",(function(e){null!=e&&e.projectVariant&&i.setVariant(e.projectVariant.uniqueId)})),S(this,"setVariant",(function(e){i.currentVariant!==e&&(i.currentVariant=e,i.update())})),S(this,"setChannel",(function(e){var t=i.getChannel(e);i.currentChannel!==t&&(i.currentChannel=t,i.update())})),this.staticStyles=" .activeMouse {pointer-events:all} .activeMouse:hover {cursor:pointer} .highlightedComponent {stroke:#868BFF; stroke-width:2px} text { -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; } text::selection { background: none; }",this.currentChannel="",this.currentVariant="No_Variant_Unique_Id",this.channels=null==n?void 0:n.channels,this.styleElement=document.createElement("style"),t.insertBefore(this.styleElement,t.firstChild),this.update(),r.bus.on("Variants:changed",this.updateVariant),r.bus.on("SchEngine:didDocumentAttach",this.setChannel),r.bus.on("SchEngine:didDocumentDettach",this.destroy)}var t,n,i;return t=e,(n=[{key:"addStyle",value:function(e){this.staticStyles=this.staticStyles+" "+e,this.update()}},{key:"update",value:function(){var e=this.staticStyles;e+=" [data-variant-id] { visibility: hidden }",e+=" .activeMouse[data-variant-id] { pointer-events:none }";var t="No_Variant_Unique_Id"===this.currentVariant?"":this.currentChannel;e+=' [data-variant-id~="'.concat(this.currentVariant).concat(t,'"] { visibility: visible }'),e+=' .activeMouse[data-variant-id~="'.concat(this.currentVariant).concat(t,'"] { pointer-events:all }'),this.styleElement.innerHTML=e}},{key:"getChannel",value:function(e){var t,n;if(!e||0===e.channelId||!this.channels)return"";var i=this.channels.filter((function(t){return t.schId===e.documentId&&t.inDM}));if(i.length<=1)return"";if(i.every((function(e){return e.name===i[0].name})))return"";var r=i.find((function(t){return t.id===e.channelId}));return null!==(t=null!==(n=null==r?void 0:r.safeName)&&void 0!==n?n:null==r?void 0:r.name)&&void 0!==t?t:""}}])&&w(t.prototype,n),i&&w(t,i),Object.defineProperty(t,"prototype",{writable:!1}),e}();function k(e){return(k="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function I(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function O(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?I(Object(n),!0).forEach((function(t){x(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):I(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function A(e,t){return(A=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function P(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,i=T(e);if(t){var r=T(this).constructor;n=Reflect.construct(i,arguments,r)}else n=i.apply(this,arguments);return D(this,n)}}function D(e,t){if(t&&("object"===k(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function T(e){return(T=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function C(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function M(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function j(e,t,n){return t&&M(e.prototype,t),n&&M(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}function x(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function L(e,t){return"EMPTY"===e?new N:"ERROR"===e?new _(t()):new z(t())}var R=function(e,t){r.bus.emit(e,t)},N=function(){function e(){C(this,e),x(this,"errorState",null),x(this,"state",{zoom:0,top:0,left:0}),x(this,"useAnimatedZoomToFit",!1)}return j(e,[{key:"type",get:function(){return"EMPTY"}},{key:"documentId",get:function(){return""}},{key:"uniqueId",get:function(){return""}},{key:"channelId",get:function(){return 0}},{key:"render",value:function(){return Promise.resolve()}},{key:"zoom",value:function(){}},{key:"zoomToFit",value:function(){return Promise.resolve()}},{key:"move",value:function(){}},{key:"destroy",value:function(){}}]),e}(),_=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&A(e,t)}(n,e);var t=P(n);function n(e){var i;return C(this,n),i=t.call(this),setTimeout((function(){return R("SchEngine:didDocumentAttachError",{error:e.errorState,documentId:e.documentId})}),0),i}return j(n)}(N),z=function(){function e(t){var n=this;C(this,e),x(this,"svg",void 0),x(this,"id",void 0),x(this,"unique",void 0),x(this,"channel",void 0),x(this,"scene",void 0),x(this,"workspace",void 0),x(this,"position",{x:0,y:0}),x(this,"originSize",{width:0,height:0}),x(this,"currentSize",{width:0,height:0}),x(this,"zoomRelativePoint",{x:0,y:0}),x(this,"scale",100),x(this,"spaceVisibilityService",void 0),x(this,"selectionService",void 0),x(this,"fitToZoomNeed",!1),x(this,"logger",r.createLogger("SchDocumentRenderer")),x(this,"selectionGroup",void 0),x(this,"selectionMaskGroup",void 0),x(this,"highlightGroup",void 0),x(this,"maskId",void 0),x(this,"maskPath",null),x(this,"selectMask",null),x(this,"selectBound",null),x(this,"styleManager",void 0),x(this,"onTransformUpdate",void 0),x(this,"overlay",void 0),x(this,"sceneInfo",void 0),x(this,"errorState",null),x(this,"useAnimatedZoomToFit",!1),x(this,"onDrawSelection",(function(e){n.logger.LogDebug("Draw selection");var t=0,i=0,r=0,o=0;if(e.items.forEach((function(e){e.channel&&e.channel!==n.channelId||n.selectionService.getActiveObjectsForItem(e).forEach((function(e){e&&(n.drawSelection(e),e.bounds&&e.bounds.forEach((function(e){i=i?Math.min(i,e.x):e.x,t=t?Math.min(t,e.y):e.y,r=r?Math.max(r,e.x+e.width):e.x+e.width,o=o?Math.max(o,e.y+e.height):e.y+e.height})))}))})),e.fit&&r-i&&o-t){var s,a={x:i,y:t,width:r-i,height:o-t};n.zoomToFit(a,!0,null!==(s=e.fitZoom)&&void 0!==s?s:.7)}})),x(this,"drawHighlight",(function(e){var t=e.localName;if("rect"===t)e.setAttribute("stroke-width","2px"),e.setAttribute("stroke","#868BFF");else if("line"===t||"polyline"===t){var i=window.getComputedStyle(e)["stroke-width"],r=1;i.match(/^\-?\d+(\.?\d*)px$/)&&(r=parseFloat(i.substring(0,i.length-2))),e.setAttribute("stroke-width","".concat(r+2,"px"))}n.highlightGroup.appendChild(e)})),x(this,"clearHighlight",(function(){for(;n.highlightGroup.firstChild;)n.highlightGroup.removeChild(n.highlightGroup.firstChild)})),this.logger.LogDebug("Create for "+t.documentId),this.id=t.documentId,this.unique=t.uniqueId,this.channel=t.channelId,this.workspace=t.workspace,this.svg=t.workspace.appendChild(t.node),this.svg.style.opacity="0",this.scene=this.svg.getElementById("scene"),this.sceneInfo=this.getSceneInfo(),this.maskId="".concat(this.scene.id,"_selection_mask"),this.selectionService=t.selectionService,this.originSize.width=this.svg.width.baseVal.value,this.originSize.height=this.svg.height.baseVal.value,this.svg.setAttribute("viewBox","0 0 ".concat(this.svg.width.baseVal.value," ").concat(this.svg.height.baseVal.value)),this.svg.setAttribute("width","".concat(this.originSize.width)),this.svg.setAttribute("height","".concat(this.originSize.height)),this.svg.setAttribute("style","width: 100%; height: 100%"),this.spaceVisibilityService=this.createSpaceVisibilityService(this.workspace),this.selectionMaskGroup=document.createElementNS("http://www.w3.org/2000/svg","g"),this.selectionMaskGroup.id=this.scene.id+"SelectionMask",this.scene.appendChild(this.selectionMaskGroup),this.selectionGroup=document.createElementNS("http://www.w3.org/2000/svg","g"),this.selectionGroup.id=this.scene.id+"Selection",this.scene.appendChild(this.selectionGroup),this.highlightGroup=document.createElementNS("http://www.w3.org/2000/svg","g"),this.highlightGroup.id=this.scene.id+"Highlight",this.scene.appendChild(this.highlightGroup),this.createMask(),this.overlay=document.createElementNS("http://www.w3.org/2000/svg","g"),this.overlay.id=this.scene.id+"Overlay",this.scene.appendChild(this.overlay);var i=new CustomEvent("didTransformChange",{detail:this.scene.transform});this.overlay.didTransformChangeEvent=i,this.onTransformUpdate=function(){return n.overlay.dispatchEvent(i)},this.styleManager=new E(this.svg,t.metadata),setTimeout((function(e){return R("SchEngine:didDocumentAttach",{workspace:n.workspace,svg:n.svg,styleManager:n.styleManager,overlay:n.overlay,uniqueId:n.uniqueId,channelId:n.channelId,documentId:n.documentId,documentWidth:n.originSize.width,documentHeight:n.originSize.height})}),0),this.clearSelection=this.clearSelection.bind(this),this.doSetupChannel(t.metadata),r.bus.on("SchEngine:clearHighlight",this.clearHighlight),r.bus.on("SchEngine:drawHighlight",this.drawHighlight),r.bus.on("SchEngine:clearSelection",this.clearSelection),r.bus.on("SchEngine:drawSelection",this.onDrawSelection)}return j(e,[{key:"type",get:function(){return"DEFAULT"}},{key:"documentId",get:function(){return this.id}},{key:"uniqueId",get:function(){return this.unique}},{key:"channelId",get:function(){return this.channel}},{key:"state",get:function(){return{zoom:this.scale,top:this.position.y,left:this.position.x}},set:function(e){this.scale=e.zoom,this.position.x=e.left,this.position.y=e.top,this.updateTransform()}},{key:"render",value:function(){var e=this;return new Promise((function(t){e.svg.style.opacity="1",e.spaceVisibilityService.onWindowResize();var n=e.selectionService.setupDocument(e);n&&e.scene.insertBefore(n,e.overlay),t()}))}},{key:"zoom",value:function(e,t,n){this.setZoomRelativePoint(e,t);var i=this.scale*(100-n)/100;this.doZoom(i),R("SchEngine:documentZoom",{type:"zoom",documentId:this.documentId,scale:i,x:e,y:t})}},{key:"zoomToFit",value:function(e,t){var n=this,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:.9;return new Promise((function(r){new Promise((function(r){e?r(O(O({},e),{margin:i,changeScale:t})):n.spaceVisibilityService.displayed?(!0,r({x:0,y:0,width:n.sceneInfo.width,height:n.sceneInfo.height,margin:i,changeScale:t})):n.fitToZoomNeed=!0})).then((function(e){return n.zoomRectangleToFit(e.x,e.y,e.width,e.height,e.margin,e.changeScale)})).then((function(){n.updateTransform(),r()})).catch((function(e){n.logger.LogError(e.message),r()}))}))}},{key:"move",value:function(e,t){var n=Math.min(this.spaceVisibilityService.size.width/this.sceneInfo.width,this.spaceVisibilityService.size.height/this.sceneInfo.height);n&&(this.position.x+=e/n,this.position.y+=t/n,this.updateTransform())}},{key:"destroy",value:function(){this.logger.LogDebug("Destroy for "+this.id),r.bus.off("SchEngine:clearHighlight",this.clearHighlight),r.bus.off("SchEngine:drawHighlight",this.drawHighlight),r.bus.off("SchEngine:clearSelection",this.clearSelection),r.bus.off("SchEngine:drawSelection",this.onDrawSelection),R("SchEngine:didDocumentDettach",null);try{this.spaceVisibilityService.destroy(),this.workspace&&(this.workspace.removeChild(this.svg),this.workspace=null)}catch(e){this.logger.LogError("Destroy renderer error. ".concat(e.message))}}},{key:"createMask",value:function(){var e=document.createElementNS("http://www.w3.org/2000/svg","defs"),t=document.createElementNS("http://www.w3.org/2000/svg","mask");t.setAttribute("id",this.maskId),t.setAttribute("maskContentUnits","userSpaceOnUse"),e.appendChild(t);var n=document.createElementNS("http://www.w3.org/2000/svg","rect");n.setAttribute("width","".concat(this.originSize.width)),n.setAttribute("height","".concat(this.originSize.height)),n.setAttribute("fill","white"),n.setAttribute("opacity","0.3"),t.appendChild(n),this.maskPath=document.createElementNS("http://www.w3.org/2000/svg","path"),this.maskPath.setAttribute("fill","black"),t.appendChild(this.maskPath),this.scene.insertBefore(e,this.scene.firstChild),this.selectMask=document.createElementNS("http://www.w3.org/2000/svg","rect"),this.selectMask.setAttribute("width","".concat(this.originSize.width)),this.selectMask.setAttribute("height","".concat(this.originSize.height)),this.selectMask.setAttribute("mask","url(#".concat(this.maskId,")")),this.selectMask.setAttribute("fill","grey"),this.selectMask.style.visibility="hidden",this.selectionMaskGroup.appendChild(this.selectMask),this.selectBound=document.createElementNS("http://www.w3.org/2000/svg","path"),this.selectBound.setAttribute("stroke","blue"),this.selectBound.setAttribute("stroke-width","3px"),this.selectBound.setAttribute("mask","url(#".concat(this.maskId,")")),this.selectBound.style.visibility="hidden",this.selectionMaskGroup.appendChild(this.selectBound)}},{key:"drawSelection",value:function(e){if(this.maskPath){if(e&&e.bounds){var t=e.bounds.map((function(e){return"M".concat(e.x," ").concat(e.y," H").concat(e.x+e.width," V").concat(e.y+e.height," H").concat(e.x," Z")})).join(" "),n=this.maskPath.getAttribute("d");n?this.maskPath.setAttribute("d",n+" "+t):this.maskPath.setAttribute("d",t),this.selectBound&&(this.selectBound.setAttribute("d",this.maskPath.getAttribute("d")),this.selectBound.style.visibility="visible"),this.selectMask&&(this.selectMask.style.visibility="visible")}if(e&&e.element){var i=e.element,r=i.localName;if("line"===r||"polyline"===r){var o=window.getComputedStyle(i)["stroke-width"],s=1;o.match(/^\-?\d+(\.?\d*)px$/)&&(s=parseFloat(o.substring(0,o.length-2))),i.setAttribute("stroke-width","".concat(s+2,"px"))}this.selectionGroup.appendChild(i)}}}},{key:"clearSelection",value:function(e){if(this.maskPath)for(this.maskPath.setAttribute("d",""),e.update||(this.selectBound&&(this.selectBound.style.visibility="hidden"),this.selectMask&&(this.selectMask.style.visibility="hidden"));this.selectionGroup.firstChild;)this.selectionGroup.removeChild(this.selectionGroup.firstChild)}},{key:"createSpaceVisibilityService",value:function(e){var t=this,n=new b(e);return n.on("didSizeChange",(function(){t.currentSize.width=n.size.width,t.currentSize.height=n.size.height,setTimeout((function(){t.onTransformUpdate&&t.onTransformUpdate()}),0)})),n.on("shown",(function(){t.fitToZoomNeed&&(t.fitToZoomNeed=!1,t.zoomToFit(null,!0)),t.currentSize.width=n.size.width,t.currentSize.height=n.size.height,setTimeout((function(){t.onTransformUpdate&&t.onTransformUpdate()}),0)})),n.on("hidden",(function(){})),n.displayed&&(this.currentSize.width=n.size.width,this.currentSize.height=n.size.height),n}},{key:"updateTransform",value:function(){var e="matrix(".concat(this.scale/100," 0 0 ").concat(this.scale/100," ").concat(this.position.x," ").concat(this.position.y,")");isNaN(this.scale)||isNaN(this.position.x)||isNaN(this.position.y)?this.logger.LogError("Transform value IsNAN"):(this.scene.setAttribute("transform",e),this.onTransformUpdate&&this.onTransformUpdate())}},{key:"setZoomRelativePoint",value:function(e,t){this.zoomRelativePoint.x=e,this.zoomRelativePoint.y=t}},{key:"zoomRectangleToFit",value:function(e,t,n,i,r,o){var s=this;return new Promise((function(a,c){if(s.sceneInfo.width&&s.sceneInfo.height)if(r<0||r>1)c(new Error("Margin [".concat(r,"] wrong value.")));else{var u=s.spaceVisibilityService.size.width,h=s.spaceVisibilityService.size.height;if(n&&0!==n&&i&&0!==i){r=Math.min(u,h)*(1-r)/2;var l=Math.min(s.spaceVisibilityService.size.width/s.sceneInfo.width,s.spaceVisibilityService.size.height/s.sceneInfo.height),d=s.spaceVisibilityService.size.width-s.sceneInfo.width*l,f=s.spaceVisibilityService.size.height-s.sceneInfo.height*l;if(l){var v=u-2*r-d,p=h-2*r-f,m=v/n,g=p/i,y=s.scale/100,b={lastX:s.position.x,lastY:s.position.y,lastScale:y};o&&(y=Math.abs(Math.min(m,g)),s.scale=Math.round(100*y)/l);var w=r+(v-n*y)/2,S=r+(p-i*y)/2;s.position.x=(-e*y+w)/l,s.position.y=(-t*y+S)/l,a(b)}}}}))}},{key:"animate",value:function(e,t,n,i){var r=this;return new Promise((function(o){if(r.useAnimatedZoomToFit&&i&&Math.min(r.spaceVisibilityService.size.width/r.sceneInfo.width,r.spaceVisibilityService.size.height/r.sceneInfo.height)){var s=r.position.x,a=r.position.y,c=r.scale/100,u=document.getElementById("animateTransformTranslateSchSvg");u||((u=document.createElementNS("http://www.w3.org/2000/svg","animateTransform")).setAttribute("id","animateTransformTranslateSchSvg"),u.setAttribute("attributeName","transform"),u.setAttribute("type","translate"),u.setAttribute("dur","0.4s"),r.scene.appendChild(u)),u.setAttribute("from","".concat(e,",").concat(t)),u.setAttribute("to","".concat(s,",").concat(a));var h=document.getElementById("animateTransformScaleSchSvg");h||((h=document.createElementNS("http://www.w3.org/2000/svg","animateTransform")).setAttribute("id","animateTransformScaleSchSvg"),h.setAttribute("attributeName","transform"),h.setAttribute("type","scale"),h.setAttribute("dur","0.4s"),h.setAttribute("additive","sum"),r.scene.appendChild(h)),h.setAttribute("from","".concat(n)),h.setAttribute("to","".concat(c)),u.beginElement&&h.beginElement&&(h.beginElement(),u.beginElement(),h.onEnd=function(){r.logger.LogDebug("Animation end")})}o()}))}},{key:"checkZoomRelativePoint",value:function(){-1===this.zoomRelativePoint.x&&-1===this.zoomRelativePoint.y&&(this.zoomRelativePoint.x=this.spaceVisibilityService.size.width/2,this.zoomRelativePoint.y=this.spaceVisibilityService.size.height/2)}},{key:"getRelativePoint",value:function(e,t,n){return e<t?t:e>n?n:e}},{key:"doZoom",value:function(e){var t=this.scene.getScreenCTM();if(t){this.checkZoomRelativePoint();var n=(e-this.scale)/100,i=this.sceneInfo.width*n,r=this.sceneInfo.height*n,o=t.e,s=this.sceneInfo.width*t.a,a=t.f,c=this.sceneInfo.height*t.a,u=this.getRelativePoint(this.zoomRelativePoint.x,o,o+s),h=this.getRelativePoint(this.zoomRelativePoint.y,a,a+c);this.position.x-=i*(u-o)/s,this.position.y-=r*(h-a)/c,this.scale=e,this.updateTransform(),this.setZoomRelativePoint(-1,-1)}}},{key:"doSetupChannel",value:function(e){var t,n=this,i=null==e||null===(t=e.channels)||void 0===t?void 0:t.find((function(e){return e.id===n.channel}));if(i&&i.index){var r=null==e?void 0:e.components;r&&r.filter((function(e){return e.schId&&e.channel===n.channel})).forEach((function(e){var t="",i=e.designator,r=i.indexOf(" (");r>0&&(t=i.substring(r+1),i=i.substring(0,r)),n.setChannelDesignator(e.designatorId,i,t)}))}}},{key:"setChannelDesignator",value:function(e,t,n){var i=0,r=0,o=this.svg.getElementById(e);o&&Array.from(o.children).forEach((function(e){if("text"===e.nodeName){var o=e;if(0===r){var s=o.textLength.baseVal.value;e.textContent=t,i=o.textLength.baseVal.value-s,r++}else if(1===r){e.textContent=n;var a="translate(".concat(i,",",0,")");return void e.setAttribute("transform",a)}}}))}},{key:"getSceneInfo",value:function(){var e=this.svg.getElementById("BackgroundGroup");if(e&&e.children.length>0){var t=e.children[0],n=Number.parseFloat(t.getAttribute("width")),i=Number.parseFloat(t.getAttribute("height"));if(!Number.isNaN(n)&&!Number.isNaN(i))return{width:n,height:i}}return{width:this.scene.getBBox().width,height:this.scene.getBBox().height}}}]),e}();function B(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function G(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?B(Object(n),!0).forEach((function(t){W(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):B(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function H(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function V(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function U(e,t,n){return t&&V(e.prototype,t),n&&V(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}function W(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var F=function(e){setTimeout((function(){e()}),0)},Y=function(){function e(){var t=this;H(this,e),W(this,"workspace",void 0),W(this,"panEventArgs",{deltaX:0,deltaY:0}),W(this,"zoomEventArgs",{delta:0,x:0,y:0}),W(this,"userPanInteract",void 0),W(this,"userSelectInteract",void 0),W(this,"ee",void 0),W(this,"onContextMenu",(function(e){t.stopBubble(e)})),W(this,"onMouseEvent",(function(){t.workspace.focus()})),W(this,"onMouseWheel",(function(e){t.zoomEventArgs.delta=e.deltaY>0?10:-10,t.zoomEventArgs.x=e.clientX,t.zoomEventArgs.y=e.clientY,F((function(){return t.emit("zoom",t.zoomEventArgs)})),t.stopBubble(e)})),W(this,"onTouchStart",(function(e){2===e.touches.length&&(t.workspace.addEventListener("touchmove",t.onTouchMove),t.workspace.addEventListener("touchend",t.onTouchEnd),t.onGestureStart(e.touches[0].clientX,e.touches[0].clientY,e.touches[1].clientX,e.touches[1].clientY)),t.stopBubble(e)})),W(this,"onTouchEnd",(function(e){1===e.touches.length&&(t.workspace.removeEventListener("touchmove",t.onTouchMove),t.workspace.removeEventListener("touchend",t.onTouchEnd),t.onGestureEnd(e.touches[0].clientX,e.touches[0].clientY)),t.stopBubble(e)})),W(this,"onTouchMove",(function(e){if(2===e.touches.length){var n=e.touches[0],i=e.touches[1];t.onGesture(n.clientX,n.clientY,i.clientX,i.clientY)}t.stopBubble(e)})),W(this,"inputGesture",{count:0,position1:{x:0,y:0},position2:{x:0,y:0},centerPoint:{x:0,y:0},startDistance:0,currentPercent:0}),this.ee=window.__CORE__.createEventEmmiterInstance(),this.userPanInteract=new q,this.userPanInteract.on("panEnter",(function(){return t.emit("panEnter")})),this.userPanInteract.on("panLeave",(function(){return t.emit("panLeave")})),this.userPanInteract.on("panMove",(function(e){return t.emit("panMove",e)})),this.userSelectInteract=new X,this.userSelectInteract.on("select",(function(e){return t.emit("select",e)}))}return U(e,[{key:"once",value:function(e,t){return this.ee.once(e,t)}},{key:"on",value:function(e,t){return this.ee.on(e,t)}},{key:"off",value:function(e,t){return this.ee.off(e,t)}},{key:"eventNames",value:function(){return this.ee.eventNames()}},{key:"emit",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];return this.ee.emit(e,t)}},{key:"attachToWorkspace",value:function(e){this.workspace=e,this.initEvents(e),this.userPanInteract.attachToWorkspace(e),this.userSelectInteract.attachToWorkspace(e)}},{key:"destroy",value:function(){this.workspace&&(this.releaseEvents(this.workspace),this.userPanInteract.destroy(),this.userSelectInteract.destroy(),this.workspace=null)}},{key:"stopBubble",value:function(e){e.preventDefault(),e.stopPropagation()}},{key:"initEvents",value:function(e){e.addEventListener("contextmenu",this.onContextMenu),e.addEventListener("mouseenter",this.onMouseEvent),e.addEventListener("wheel",this.onMouseWheel),e.addEventListener("mousewheel",this.onMouseWheel),e.addEventListener("touchstart",this.onTouchStart)}},{key:"releaseEvents",value:function(e){e.removeEventListener("contextmenu",this.onContextMenu),e.removeEventListener("mouseenter",this.onMouseEvent),e.removeEventListener("wheel",this.onMouseWheel),e.removeEventListener("mousewheel",this.onMouseWheel),e.removeEventListener("touchstart",this.onTouchStart)}},{key:"updateGestureStartPoint",value:function(e,t,n,i){this.inputGesture.position1.x=e,this.inputGesture.position1.y=t,this.inputGesture.position2.x=n,this.inputGesture.position2.y=i;var r=n-e,o=i-t;this.inputGesture.startDistance=Math.sqrt(r*r+o*o),this.inputGesture.currentPercent=100,this.inputGesture.centerPoint.x=e>n?n+(e-n)/2:e+(n-e)/2,this.inputGesture.centerPoint.y=t>i?i+(t-i)/2:t+(i-t)/2}},{key:"onGestureStart",value:function(e,t,n,i){this.updateGestureStartPoint(e,t,n,i)}},{key:"onGesture",value:function(e,t,n,i){var r=this;if(2==this.inputGesture.count++){this.inputGesture.count=0;var o=e-this.inputGesture.position1.x,s=t-this.inputGesture.position1.y,a=n-this.inputGesture.position2.x,c=i-this.inputGesture.position2.y;if(o>0==a>0&&s>0==c>0)return this.panEventArgs.deltaX=Math.abs(o)<Math.abs(a)?o:a,this.panEventArgs.deltaY=Math.abs(s)<Math.abs(c)?s:c,F((function(){return r.emit("panMove",r.panEventArgs)})),void this.updateGestureStartPoint(e,t,n,i);var u=n-e,h=i-t,l=Math.sqrt(u*u+h*h),d=Math.round(this.inputGesture.startDistance/l*100);this.zoomEventArgs.delta=d-this.inputGesture.currentPercent,this.zoomEventArgs.x=this.inputGesture.centerPoint.x,this.zoomEventArgs.y=this.inputGesture.centerPoint.y,F((function(){return r.emit("zoom",r.zoomEventArgs)})),this.inputGesture.currentPercent=d}}},{key:"onGestureEnd",value:function(e,t){this.updateGestureStartPoint(0,0,0,0)}}]),e}(),X=function(){function e(){var t=this;H(this,e),W(this,"workspace",void 0),W(this,"initClientX",0),W(this,"initClientY",0),W(this,"ee",void 0),W(this,"onMouseDown",(function(e){0===e.button&&(t.initClientX=e.clientX,t.initClientY=e.clientY,t.workspace.addEventListener("mouseup",t.onMouseUp),t.workspace.addEventListener("mousemove",t.onMouseMove))})),W(this,"onMouseMove",(function(n){Math.abs(t.initClientX-n.clientX)<e.delta&&Math.abs(t.initClientY-n.clientY)<e.delta||(t.workspace.removeEventListener("mouseup",t.onMouseUp),t.workspace.removeEventListener("mousemove",t.onMouseMove))})),W(this,"onMouseUp",(function(e){t.workspace.removeEventListener("mouseup",t.onMouseUp),t.workspace.removeEventListener("mousemove",t.onMouseMove),t.emitSelect(e.currentTarget,e)})),W(this,"onTouchStart",(function(e){1===e.touches.length?(t.initClientX=e.touches[0].clientX,t.initClientY=e.touches[0].clientY,t.workspace.addEventListener("touchmove",t.onTouchMove),t.workspace.addEventListener("touchend",t.onTouchEnd)):2===e.touches.length&&(t.workspace.removeEventListener("touchmove",t.onTouchMove),t.workspace.removeEventListener("touchend",t.onTouchEnd))})),W(this,"onTouchMove",(function(n){Math.abs(t.initClientX-n.touches[0].clientX)<e.delta&&Math.abs(t.initClientY-n.touches[0].clientY)<e.delta||(t.workspace.removeEventListener("touchmove",t.onTouchMove),t.workspace.removeEventListener("touchend",t.onTouchEnd))})),W(this,"onTouchEnd",(function(e){t.emitSelect(e.currentTarget,e.changedTouches[0])})),this.ee=window.__CORE__.createEventEmmiterInstance()}return U(e,[{key:"once",value:function(e,t){return this.ee.once(e,t)}},{key:"on",value:function(e,t){return this.ee.on(e,t)}},{key:"off",value:function(e,t){return this.ee.off(e,t)}},{key:"eventNames",value:function(){return this.ee.eventNames()}},{key:"emit",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];return this.ee.emit(e,t)}},{key:"attachToWorkspace",value:function(e){this.workspace=e,this.initEvents(e)}},{key:"destroy",value:function(){this.workspace&&(this.releaseEvents(this.workspace),this.workspace=null)}},{key:"initEvents",value:function(e){e&&(e.addEventListener("mousedown",this.onMouseDown),e.addEventListener("touchstart",this.onTouchStart))}},{key:"releaseEvents",value:function(e){e&&(e.removeEventListener("mousedown",this.onMouseDown),e.removeEventListener("touchstart",this.onTouchStart))}},{key:"emitSelect",value:function(e,t){var n=this;e.removeEventListener("touchmove",this.onTouchMove),e.removeEventListener("touchend",this.onTouchEnd),F((function(){n.emit("select",{x:t.clientX,y:t.clientY})}))}}]),e}();W(X,"delta",1);var q=function(){function e(){var t=this;H(this,e),W(this,"workspace",void 0),W(this,"isEnter",!1),W(this,"panEventArgs",{deltaX:0,deltaY:0,x:0,y:0}),W(this,"ee",void 0),W(this,"onMouseDown",(function(e){1!==e.buttons&&2!==e.buttons||(t.panEventArgs.deltaX=0,t.panEventArgs.deltaY=0,t.panEventArgs.x=e.clientX,t.panEventArgs.y=e.clientY,t.workspace.addEventListener("mouseup",t.onMouseUp),t.workspace.addEventListener("mouseleave",t.onMouseLeave),t.workspace.addEventListener("mousemove",t.onMouseMove),t.workspace.addEventListener("mouseenter",t.onMouseEnter))})),W(this,"onMouseEnter",(function(e){1===e.buttons||2===e.buttons?(t.panEventArgs.deltaX=0,t.panEventArgs.deltaY=0,t.panEventArgs.x=e.clientX,t.panEventArgs.y=e.clientY,t.workspace.addEventListener("mouseup",t.onMouseUp),t.workspace.addEventListener("mouseleave",t.onMouseLeave),t.workspace.addEventListener("mousemove",t.onMouseMove)):t.workspace.removeEventListener("mouseenter",t.onMouseEnter)})),W(this,"onMouseUp",(function(e){t.isEnter=!1,F((function(){return t.emit("panLeave")})),t.workspace.removeEventListener("mouseup",t.onMouseUp),t.workspace.removeEventListener("mouseleave",t.onMouseLeave),t.workspace.removeEventListener("mousemove",t.onMouseMove),t.workspace.removeEventListener("mouseenter",t.onMouseEnter)})),W(this,"onMouseLeave",(function(e){t.isEnter=!1,F((function(){return t.emit("panLeave")})),t.workspace.removeEventListener("mouseup",t.onMouseUp),t.workspace.removeEventListener("mouseleave",t.onMouseLeave),t.workspace.removeEventListener("mousemove",t.onMouseMove)})),W(this,"onMouseMove",(function(n){if(!(Math.abs(t.panEventArgs.x-n.clientX)<e.delta&&Math.abs(t.panEventArgs.y-n.clientY)<e.delta)){t.isEnter||(t.isEnter=!0,F((function(){return t.emit("panEnter")}))),t.panEventArgs.deltaX=n.clientX-t.panEventArgs.x,t.panEventArgs.deltaY=n.clientY-t.panEventArgs.y,t.panEventArgs.x=n.clientX,t.panEventArgs.y=n.clientY;var i=G({},t.panEventArgs);F((function(){return t.emit("panMove",i)}))}})),W(this,"onTouchStart",(function(e){1===e.touches.length?(t.panEventArgs.deltaX=0,t.panEventArgs.deltaY=0,t.panEventArgs.x=e.touches[0].clientX,t.panEventArgs.y=e.touches[0].clientY,t.workspace.addEventListener("touchmove",t.onTouchMove),t.workspace.addEventListener("touchend",t.onTouchEnd)):2===e.touches.length&&(t.workspace.removeEventListener("touchmove",t.onTouchMove),t.workspace.removeEventListener("touchend",t.onTouchEnd))})),W(this,"onTouchMove",(function(n){if(!(Math.abs(t.panEventArgs.x-n.touches[0].clientX)<e.delta&&Math.abs(t.panEventArgs.y-n.touches[0].clientY)<e.delta)){t.isEnter||(t.isEnter=!0,F((function(){return t.emit("panEnter")}))),t.panEventArgs.deltaX=n.touches[0].clientX-t.panEventArgs.x,t.panEventArgs.deltaY=n.touches[0].clientY-t.panEventArgs.y,t.panEventArgs.x=n.touches[0].clientX,t.panEventArgs.y=n.touches[0].clientY;var i=G({},t.panEventArgs);F((function(){return t.emit("panMove",i)}))}})),W(this,"onTouchEnd",(function(e){1===e.touches.length?(t.panEventArgs.deltaX=0,t.panEventArgs.deltaY=0,t.panEventArgs.x=e.touches[0].clientX,t.panEventArgs.y=e.touches[0].clientY,t.workspace.addEventListener("touchmove",t.onTouchMove),t.workspace.addEventListener("touchend",t.onTouchEnd)):0===e.touches.length&&(t.isEnter=!1,F((function(){return t.emit("panLeave")})),t.workspace.removeEventListener("touchmove",t.onTouchMove),t.workspace.removeEventListener("touchend",t.onTouchEnd))})),this.ee=window.__CORE__.createEventEmmiterInstance()}return U(e,[{key:"once",value:function(e,t){return this.ee.once(e,t)}},{key:"on",value:function(e,t){return this.ee.on(e,t)}},{key:"off",value:function(e,t){return this.ee.off(e,t)}},{key:"eventNames",value:function(){return this.ee.eventNames()}},{key:"emit",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];return this.ee.emit(e,t)}},{key:"attachToWorkspace",value:function(e){this.workspace=e,this.initEvents(e)}},{key:"destroy",value:function(){this.workspace&&(this.releaseEvents(this.workspace),this.workspace=null)}},{key:"initEvents",value:function(e){e.addEventListener("mousedown",this.onMouseDown),e.addEventListener("touchstart",this.onTouchStart)}},{key:"releaseEvents",value:function(e){e.removeEventListener("mousedown",this.onMouseDown),e.removeEventListener("touchstart",this.onTouchStart)}}]),e}();function Z(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function $(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Z(Object(n),!0).forEach((function(t){K(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Z(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function J(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function K(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}W(q,"delta",1);var Q=function(){function e(t){var n=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),K(this,"documentContainer",void 0),K(this,"emptyDocumentRenederer",void 0),K(this,"documentRenederer",void 0),K(this,"metadata",null),K(this,"userInteractionService",void 0),K(this,"documentRenderState",void 0),K(this,"renderStates",new Map),K(this,"selectionService",void 0),this.emptyDocumentRenederer=L("EMPTY",(function(){return null})),this.documentRenederer=this.emptyDocumentRenederer,this.selectionService=t,this.documentRenderState=new m(this),this.userInteractionService=new Y,this.userInteractionService.on("zoom",(function(e){n.documentRenederer.zoom(e.x,e.y,e.delta)})),this.userInteractionService.on("panMove",(function(e){n.documentRenederer.move(e.deltaX,e.deltaY),r.bus.emit("SchEngine:documentMove",{type:"move",documentId:n.documentRenederer.documentId,x:e.x,y:e.y})})),this.userInteractionService.on("select",(function(e){r.bus.emit("SchEngine:documentClick",$($({},e),{},{type:"click",documentId:n.documentRenederer.documentId})),n.selectionService.selectByPoint(e)})),r.bus.on("SchEngine:zoomToFit",(function(e){return n.documentRenederer.zoomToFit(e.rect,e.changeScale,e.margin)}))}var t,n,i;return t=e,(n=[{key:"doAttachToWorkspace",value:function(e){var t=document.createElement("div");t.setAttribute("id","sch_document_viewer"),t.setAttribute("oncontextmenu","return false");var n=t.style;n.width="100%",n.height="100%",n.position="relative",n.overflow="hidden",this.documentContainer=e.appendChild(t),this.userInteractionService.attachToWorkspace(this.documentContainer)}},{key:"doAttachDocument",value:function(e){var t=this;try{if(null!==e.errorState)throw e.errorState;var n=e.renderData.documentElement.cloneNode(!0);this.documentRenederer=L("DEFAULT",(function(){return{workspace:t.documentContainer,node:n,uniqueId:e.uniqueId,channelId:e.channelId,documentId:e.id,selectionService:t.selectionService,metadata:t.metadata}})),this.documentRenederer.useAnimatedZoomToFit=!0}catch(t){this.documentRenederer=L("ERROR",(function(){return{errorState:t,documentId:e.id}}))}}},{key:"doDettachDocument",value:function(){"EMPTY"!==this.documentRenederer.type&&(this.saveState(),this.documentRenederer.destroy(),this.documentRenederer=this.emptyDocumentRenederer)}},{key:"saveState",value:function(){"DEFAULT"===this.documentRenederer.type&&this.renderStates.set(this.documentRenederer.uniqueId,this.documentRenederer.state)}},{key:"attachTo",value:function(e){this.documentRenderState.setup(e)}},{key:"attach",value:function(e){this.documentRenederer&&e.uniqueId===this.documentRenederer.uniqueId||(this.documentRenderState.dettachDocument(),this.documentRenderState.attachDocument(e))}},{key:"setPosition",value:function(e){var t=this,n=this.renderStates.get(e.uniqueId);return n?new Promise((function(e){t.documentRenederer.state=n,e()})):this.documentRenederer.zoomToFit(null,!0,.9)}},{key:"setMetadata",value:function(e){this.metadata=e}},{key:"render",value:function(e){return this.attach(e),this.documentRenederer.render()}},{key:"reset",value:function(){this.documentRenederer.zoomToFit(null,!0,.9),r.bus.emit("SchEngine:resetDocumentView",{type:"reset",documentId:this.documentRenederer.documentId})}}])&&J(t.prototype,n),i&&J(t,i),Object.defineProperty(t,"prototype",{writable:!1}),e}(),ee=n(28);function te(e){return(te="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function ne(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function ie(e,t){return(ie=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function re(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,i=ae(e);if(t){var r=ae(this).constructor;n=Reflect.construct(i,arguments,r)}else n=i.apply(this,arguments);return oe(this,n)}}function oe(e,t){if(t&&("object"===te(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return se(e)}function se(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function ae(e){return(ae=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function ce(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var ue,he={where:function(e){return["Show"===e.type]},to:"SHOW"},le={where:function(e){return["Error"===e.type]},to:"CRASHED",error:!0},de={IDLE:[{where:function(e){return["Setup"===e.type]},to:"SETUP"}],SETUP:[{where:function(e){return["SetupComplete"===e.type]},to:"SETUP_COMPLETED"},le],SETUP_COMPLETED:[{where:function(e){return["Attach"===e.type]},to:"ATTACH"},le],ATTACH:[{where:function(e){return["AttachComplete"===e.type]},to:"ATTACH_COMPLETED"},le],ATTACH_COMPLETED:[he],SHOW:[{where:function(e){return["Close"===e.type]},to:"CLOSE"}],CLOSE:[he]},fe=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&ie(e,t)}(o,e);var t,n,i,r=re(o);function o(e){var t;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,o),ce(se(t=r.call(this,"IDLE",de)),"owner",void 0),ce(se(t),"errorState",null),ce(se(t),"onSetup",(function(e){try{var n=e.core;t.owner.doSetup(n),t.nextTick((function(){return t.dispatch({type:"SetupComplete"})}))}catch(e){t.nextTick((function(){return t.dispatch(new ee.a(e.message,e))}))}})),ce(se(t),"onAttachToWorkspace",(function(e){try{t.owner.doAttachToWorkspace(e.workspace),t.nextTick((function(){return t.dispatch({type:"AttachComplete"})}))}catch(e){t.nextTick((function(){return t.dispatch(new ee.a(e.message,e))}))}})),ce(se(t),"onShow",(function(){t.owner.doShow().catch((function(e){t.nextTick((function(){return t.dispatch(new ee.a(e.message,e))}))}))})),ce(se(t),"onClose",(function(){t.owner.doClose()})),t.owner=e,t.on("SETUP",t.onSetup),t.on("ATTACH",t.onAttachToWorkspace),t.on("SHOW",t.onShow),t.on("CLOSE",t.onClose),t}return t=o,(n=[{key:"goToSetup",value:function(e){var t=this;return new Promise((function(n,i){t.dispatch({type:"Setup",core:e})||"SETUP"===t.state?(t.on("SETUP_COMPLETED",(function(){n()})),t.on("CRASHED",(function(e){t.errorState=e,i(t.errorState)}))):"CRASHED"===t.state?i(t.errorState):n()}))}},{key:"goToAttach",value:function(e){var t=this;return new Promise((function(n,i){t.dispatch({type:"Attach",workspace:e})||"ATTACH"===t.state?(t.on("ATTACH_COMPLETED",(function(){n()})),t.on("CRASHED",(function(e){t.errorState=e,i(t.errorState)}))):"CRASHED"===t.state?i(t.errorState):n()}))}},{key:"goToShow",value:function(){var e=this;return new Promise((function(t,n){e.dispatch({type:"Show"})||"SHOW"===e.state?t():n("Cannot show. Wrong state [".concat(e.state,"]"))}))}},{key:"goToClose",value:function(){var e=this;return new Promise((function(t,n){e.dispatch({type:"Close"})||"CLOSE"===e.state?t():n("Cannot show. Wrong state [".concat(e.state,"]"))}))}},{key:"nextTick",value:function(e){setTimeout((function(){e()}))}}])&&ne(t.prototype,n),i&&ne(t,i),Object.defineProperty(t,"prototype",{writable:!1}),o}(o.a);!function(e){e[e.Component=1]="Component",e[e.Net=2]="Net",e[e.Wire=3]="Wire",e[e.Port=4]="Port",e[e.SheetEntry=5]="SheetEntry",e[e.SheetSymbol=6]="SheetSymbol"}(ue||(ue={}));var ve=n(175);function pe(e){return function(e){if(Array.isArray(e))return me(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||function(e,t){if(!e)return;if("string"==typeof e)return me(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return me(e,t)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function me(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=new Array(t);n<t;n++)i[n]=e[n];return i}function ge(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function ye(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var be=function(){function e(t,n,i,r,o){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),ye(this,"owner",void 0),ye(this,"type",void 0),ye(this,"id",void 0),ye(this,"parts",void 0),ye(this,"channel",void 0),ye(this,"hasBounds",!1),ye(this,"boundElement",null),ye(this,"variantBounds",null),ye(this,"ee",void 0),this.ee=window.__CORE__.createEventEmmiterInstance(),this.owner=t,this.type=n,this.id=i,this.parts=r,this.channel=o}var t,n,i;return t=e,(n=[{key:"once",value:function(e,t){return this.ee.once(e,t)}},{key:"on",value:function(e,t){return this.ee.on(e,t)}},{key:"off",value:function(e,t){return this.ee.off(e,t)}},{key:"eventNames",value:function(){return this.ee.eventNames()}},{key:"emit",value:function(e,t){return this.ee.emit(e,t)}},{key:"getRootOwner",value:function(){return this.owner?this.owner.getRootOwner():this}},{key:"test",value:function(e){return!!this.boundElement&&this.boundElement.test(e)}},{key:"updateBoundRectangles",value:function(t){var n=this;if(this.type!==ue.Net){if(!this.hasBounds){var i=document.getElementById(this.id),r=new Map;this.boundElement=function t(i,r){if(i&&i.localName){var o=i.localName;if("g"===o){if(n.type===ue.Component){var s=i.querySelectorAll("[data-variant-id]");if(s&&s.length>0){s.forEach((function(e){r.set(e.dataset.variantId,ve.a.getPathForGroup(e))}));var a=pe(r.keys()).find((function(e){return e.includes("No_Variant_Unique_Id")}));return r.get(a)}return ve.a.getPathForGroup(i)}if(n.type===ue.Wire)try{for(var c=[],u=0;u<i.children.length;u++){var h=t(i.children[u],null);h&&c.push(h)}return ve.a.join(c)}catch(t){e.logger.LogError("Setup wire error. "+t.message)}else{if(n.type===ue.Port)return ve.a.getPathForGroup(i);if(n.type===ue.SheetEntry)return ve.a.getPathForGroup(i);if(n.type===ue.SheetSymbol)return ve.a.getPathForGroup(i)}}else{if("line"===o)return ve.a.getPathForLine(i);if("ellipse"===o)return ve.a.getPathForEllipse(i);if("polyline"===o)return ve.a.getPathForPolyLine(i);if("polygon"===o)return ve.a.getPathForPolygon(i)}}return null}(i,r),this.variantBounds=r.size>0?r:null}t.set(this.id,this)}this.hasBounds=!0,this.parts&&this.parts.forEach((function(e){return e.updateBoundRectangles(t)}))}},{key:"updateScene",value:function(e,t,n,i){var r=this;if(this.hasBounds)if(this.parts&&0!==this.parts.length){var o=document.createElementNS("http://www.w3.org/2000/svg","g");o.setAttribute("data_id",this.id),o.setAttribute("data_type","".concat(this.type));var s=this.getRootElement(this.boundElement,n,i);s&&o.appendChild(s),this.parts.forEach((function(t){return t.updateScene(e,o,n,i)})),t.appendChild(o)}else{if(this.type===ue.Net)return;var a=function(e,o){var s=r.getRootElement(e,n,i);s&&(s.setAttribute("data_id",r.id),s.setAttribute("data_type","".concat(r.type)),o&&s.setAttribute("data-variant-id","".concat(o)),t.appendChild(s))};this.variantBounds?this.variantBounds.forEach((function(e,t){return a(e,t)})):a(this.boundElement,null)}}},{key:"setBound",value:function(e){var t;this.variantBounds&&(this.boundElement=null!==(t=this.variantBounds.get(e))&&void 0!==t?t:this.boundElement)}},{key:"getRootElement",value:function(e,t,n){var i=this;if(!e)return null;var r=e.createSvgElement((function(e){e.setAttribute("class",t),e.addEventListener("mouseenter",(function(){setTimeout((function(){var e=i.getRootOwner();e.emit("highlightStart",e)}),1)})),e.addEventListener("mouseleave",(function(){setTimeout((function(){var e=i.getRootOwner();e.emit("highlightComplete",e)}),1)})),n(e)}));return r||null}}])&&ge(t.prototype,n),i&&ge(t,i),Object.defineProperty(t,"prototype",{writable:!1}),e}();ye(be,"logger",window.__CORE__.createLogger("SchActiveObject"));var we,Se=n(79);function Ee(e){return(e?e.kind:0)>>8&255}!function(e){e[e.Wire=19]="Wire",e[e.Component=26]="Component",e[e.Port=38]="Port",e[e.SheetEntry=40]="SheetEntry",e[e.SheetSymbol=41]="SheetSymbol"}(we||(we={}));var ke=n(224);function Ie(e){return function(e){if(Array.isArray(e))return Oe(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||function(e,t){if(!e)return;if("string"==typeof e)return Oe(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return Oe(e,t)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function Oe(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=new Array(t);n<t;n++)i[n]=e[n];return i}function Ae(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Pe(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function De(e,t,n){return t&&Pe(e.prototype,t),n&&Pe(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}function Te(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var Ce=function(){function e(t,n,i){Ae(this,e),Te(this,"schId",void 0),Te(this,"channelId",void 0),Te(this,"primitives",void 0),this.schId=t,this.channelId=n,this.primitives=i||[]}return De(e,[{key:"documentId",get:function(){return Object(ke.a)(this.schId,this.channelId)}}]),e}(),Me=function(){function e(){Ae(this,e),Te(this,"channels",null),Te(this,"primitives",null),Te(this,"links",null)}return De(e,[{key:"setup",value:function(t){t&&(this.channels=t.channels?t.channels:[],this.primitives=t.primitives?t.primitives:[],this.links=new Map(t.primitives?t.primitives.filter((function(t){return e.isNavigatedPrimitive(t)})).map((function(e){return[e.schId,e]})):[]))}},{key:"getLinks",value:function(){return Ie(this.links.values())}},{key:"canNavigate",value:function(e){return!!this.links.get(e)}},{key:"invoke",value:function(e,t){var n=this.getNavigationItems(e,t);this.navigateTo(n)}},{key:"getNavigationItems",value:function(e,t){var n=this.links.get(e),i=t?this.channels.find((function(e){return e.id===t})):null;if(n&&i)switch(Ee(n)){case we.Port:if(i.parentId){var r=this.channels.find((function(e){return e.id===i.parentId}));if(r){var o=this.findPrimitive(r.schId,we.SheetEntry,i.id,n.itemLink);if(o)return new Ce(r.schId,r.id,[o])}}break;case we.SheetEntry:case we.SheetSymbol:if(!Array.isArray(n.channelLinks))break;var s=this.channels.find((function(e){return n.channelLinks.find((function(t){return t===e.id}))}));if(s){if(n.itemLink){var a=this.findPrimitive(s.schId,we.Port,0,n.itemLink);if(a)return new Ce(s.schId,s.id,[a])}return new Ce(s.schId,s.id,[])}}}},{key:"findPrimitive",value:function(e,t,n,i){return this.primitives.find((function(r){return r.schDocId===e&&Ee(r)==t&&r.itemLink===i&&(!n||r.channelLinks&&r.channelLinks.find((function(e){return e===n})))}))}},{key:"navigateTo",value:function(e){var t=this;if(e)return new Promise((function(n){var i=function(){setTimeout((function(){0==e.primitives.length?r.bus.emit("SchEngine:zoomToFit",{rect:null,changeScale:!0}):(r.bus.emit("SchEngine:clearSelection",{update:!0}),r.bus.emit("SchEngine:drawSelection",{items:e.primitives,fit:!0,fitZoom:.05}))}),100),r.bus.off("SCHView:documentChanged",i),n()}.bind(t);r.bus.on("SCHView:documentChanged",i),r.bus.emit("SCHView:showDocument",e.documentId)}))}}],[{key:"isNavigatedPrimitive",value:function(e){return!(!e||!e.channelLinks&&!e.itemLink)}}]),e}();function je(e){return function(e){if(Array.isArray(e))return Le(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||xe(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function xe(e,t){if(e){if("string"==typeof e)return Le(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?Le(e,t):void 0}}function Le(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=new Array(t);n<t;n++)i[n]=e[n];return i}function Re(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function Ne(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var _e=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),Ne(this,"activeObjects",new Map),Ne(this,"metadata",null),Ne(this,"boundsMap",new Map),Ne(this,"idsMaps",new Map),Ne(this,"logger",void 0),Ne(this,"navigation",void 0),Ne(this,"selectionEnabled",!0),Ne(this,"currentState",null),this.logger=r.createLogger("SchEngine:selectionService"),this.navigation=new Me}var t,n,i;return t=e,(n=[{key:"setup",value:function(e){var t=this;if(e){this.metadata=e,this.activeObjects.clear();var n=new Map(e.primitives?e.primitives.map((function(e,t){return[t,e]})):[]);this.setupPrimitives(e.components),this.setupNets(e.nets,n),this.setupNavigation(e),r.bus.on("Variants:set",(function(e){t.currentState&&(t.currentState.activeObjects.forEach((function(t){return t.setBound(e)})),t.launchSelection(null))}))}else console.error("Metadata object is undefined or null")}},{key:"changeState",value:function(e){var t;this.selectionEnabled=e,null!==(t=this.currentState)&&void 0!==t&&t.activeObjectsGroup&&(this.currentState.activeObjectsGroup.style.display=e?"":"none")}},{key:"setupBounds",value:function(e){var t=this;if(e){var n=e.documentId;if(n){var i=this.idsMaps.get(n);i||(i=new Map,this.idsMaps.set(n,i));try{var r=window.document.createElement("div");window.document.body.appendChild(r);try{r.appendChild(e.node.cloneNode(!0)),this.getActiveObjects(n).forEach((function(e){t.currentState&&e.channel&&e.channel!==t.currentState.channelId||e.updateBoundRectangles(i)}))}finally{window.document.body.removeChild(r)}}catch(e){this.logger.LogWarn("Setup document error. "+e.message)}}}}},{key:"setupDocument",value:function(e){var t=this;this.currentState=null,this.boundsMap.clear();var n=e.documentId;if(n){this.selectionEnabled=!0;var i=this.idsMaps.get(e.id);i||(i=new Map,this.idsMaps.set(e.id,i));var r={documentId:n,channelId:e.channelId,svg:e.svg,scene:e.scene,svgPoint:e.svg.createSVGPoint(),activeObjects:this.getActiveObjects(n),activeObjectsGroup:document.createElementNS("http://www.w3.org/2000/svg","g"),ids:i};r.activeObjectsGroup.id=r.scene.id+"ActiveObjects";for(var o=0;o<r.scene.children.length;o++){var s=r.scene.children[o];if(s.id===r.activeObjectsGroup.id){r.scene.removeChild(s);break}}return r.activeObjects.forEach((function(e){e.channel&&e.channel!==r.channelId||(e.updateBoundRectangles(r.ids),e.updateScene(r.svg,r.activeObjectsGroup,"activeMouse",(function(n){t.boundsMap.set(n,e)})))})),this.currentState=r,r.activeObjectsGroup}}},{key:"selectByPoint",value:function(e){if(this.currentState){this.currentState.svgPoint.x=e.x,this.currentState.svgPoint.y=e.y;var t=this.currentState.scene.getScreenCTM();if(t){var n,i=this.currentState.svgPoint.matrixTransform(t.inverse()),r=function(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=xe(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var i=0,r=function(){};return{s:r,n:function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}},e:function(e){throw e},f:r}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,s=!0,a=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return s=e.done,e},e:function(e){a=!0,o=e},f:function(){try{s||null==n.return||n.return()}finally{if(a)throw o}}}}(this.currentState.ids.values());try{for(r.s();!(n=r.n()).done;){var o=n.value;if(o.test(i))return void(this.navigation.canNavigate(o.id)?this.navigation.invoke(o.id,this.currentState.channelId):this.launchSelection(o.getRootOwner()))}}catch(e){r.e(e)}finally{r.f()}this.launchSelection(null)}}}},{key:"getActiveObjectsForItem",value:function(e){var t=this,n=[];return this.getActiveObjectById(e.schId,n),e.subParts&&e.subParts.forEach((function(e){return t.getActiveObjectById(e.schId,n)})),n}},{key:"canSelect",value:function(e){return Ee(e)===we.Wire}},{key:"getActiveObjectById",value:function(e,t){if(this.currentState){var n=this.currentState.ids.get(e);if(n&&n.boundElement&&n.boundElement.selectedPath){var i={element:null,bounds:n.boundElement.selectedPath};n.type===ue.Wire&&this.setupWireHighlight(document.getElementById(n.id),n,(function(e){return t.push({element:e})})),t.push(i)}}}},{key:"launchSelection",value:function(e){var t=this;if(this.metadata){var n=this.metadata;if(this.currentState){var i=null;if(e)if(e.type===ue.Component&&e.id){var o=this.currentState.documentId,s=n.components.find((function(n){return(!n.channel||!t.currentState||n.channel===t.currentState.channelId)&&(n.schId===e.id&&n.schDocId===o||!!n.subParts&&n.subParts.find((function(t){return t.schId===e.id&&t.schDocId===o})))}));s&&(i=Object(Se.a)("component",s,"SchEngine"))}else if(e.type===ue.Net){var a=n.nets[parseInt(e.id)];i=Object(Se.a)("net",a,"SchEngine")}i&&!this.selectionEnabled||r.bus.emit("select",i||null)}}}},{key:"getActiveObjects",value:function(e){if(!e)return[];var t=this.activeObjects.get(e);return t||[]}},{key:"createActiveObject",value:function(e,t,n,i){var o=this,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,a=new be(e,t,n,i,s);return a.on("highlightStart",(function(e){o.invokeHighlight(a)})),a.on("highlightComplete",(function(){return r.bus.emit("SchEngine:clearHighlight")})),a}},{key:"addActiveObject",value:function(e,t){if(e&&t){var n=this.activeObjects.get(e);n||(n=[],this.activeObjects.set(e,n)),n.push(t)}}},{key:"setupPrimitives",value:function(e){var t=this;e&&e.forEach((function(e){e.kind&&Ee(e)===we.Component&&t.setupComponent(e)}))}},{key:"setupNets",value:function(e,t){var n=this;e&&t&&e.forEach((function(e,i){n.setupNet(e,i,t)}))}},{key:"setupNet",value:function(e,t,n){var i=this;if(e.primitives){var r=e.primitives.map((function(e){return n.get(e)})).filter((function(e){return void 0!==e})).filter((function(e){return i.canSelect(e)}));if(r.length){var o=r.reduce((function(e,t){return e[t.schDocId]=[].concat(je(e[t.schDocId]||[]),[t]),e}),{});Object.keys(o).forEach((function(n){var r=[],s=i.createActiveObject(null,ue.Net,"".concat(t),r,e.channel);o[n]&&o[n].forEach((function(t){r.find((function(e){return e.id===t.schId}))||r.push(i.createActiveObject(s,ue.Wire,t.schId,null,e.channel))})),i.addActiveObject(n,s)}))}}}},{key:"setupComponent",value:function(e){var t=this;if(e.schId&&e.schDocId)if(e.subParts){var n=new Map;n.set(e.schDocId,[e]),e.subParts.forEach((function(e){n.has(e.schDocId)?n.get(e.schDocId).push(e):n.set(e.schDocId,[e])})),n.forEach((function(n,i){if(0!==n.length){var r=[],o=t.createActiveObject(null,ue.Component,n[0].schId,r,e.channel);t.addActiveObject(i,o),0!==(n=n.slice(1)).length&&n.forEach((function(n){return r.push(t.createActiveObject(o,ue.Component,n.schId,null,e.channel))}))}}))}else{var i=this.createActiveObject(null,ue.Component,e.schId,[],e.channel);this.addActiveObject(e.schDocId,i)}}},{key:"setupNavigation",value:function(e){var t=this;this.navigation.setup(e);var n=[];this.navigation.getLinks().forEach((function(e){var i=function(e){switch(Ee(e)){case we.Component:return ue.Component;case we.Port:return ue.Port;case we.SheetEntry:return ue.SheetEntry;case we.SheetSymbol:return ue.SheetSymbol;case we.Wire:return ue.Wire}return 0}(e),r=t.createActiveObject(null,i,e.schId,null);i===ue.SheetSymbol?n.push({docId:e.schDocId,obj:r}):t.addActiveObject(e.schDocId,r)})),n.forEach((function(e){t.addActiveObject(e.docId,e.obj)}))}},{key:"invokeHighlight",value:function(e){var t=this;this.currentState&&(e.type===ue.Component?e.boundElement&&e.boundElement.selectedPath&&e.boundElement.selectedPath.forEach((function(t){var n=t.createSvgElement(3);n.setAttribute("data-id",e.id),r.bus.emit("SchEngine:drawHighlight",n)})):e.type===ue.Wire&&this.setupWireHighlight(this.currentState.svg.getElementById(e.id),e,(function(e){return r.bus.emit("SchEngine:drawHighlight",e)})),e.parts&&e.parts.forEach((function(e){return t.invokeHighlight(e)})))}},{key:"setupWireHighlight",value:function(e,t,n){var i=this;if(e&&e.localName){var r=e.localName;if("g"===r)this.forEveryChild(e,(function(e){return i.setupWireHighlight(e,t,n)}));else if("line"===r||"polyline"===r){var o=e.cloneNode(!0);o.setAttribute("data-id",t.id),o.hasAttribute("id")&&o.removeAttribute("id"),n(o)}}}},{key:"forEveryChild",value:function(e,t){for(var n=e.children,i=0;i<n.length;i++){var r=n[i];r&&t(r)}}}])&&Re(t.prototype,n),i&&Re(t,i),Object.defineProperty(t,"prototype",{writable:!1}),e}(),ze=n(94);function Be(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function Ge(e,t,n,i,r,o,s){try{var a=e[o](s),c=a.value}catch(e){return void n(e)}a.done?t(c):Promise.resolve(c).then(i,r)}function He(e){return function(){var t=this,n=arguments;return new Promise((function(i,r){var o=e.apply(t,n);function s(e){Ge(o,i,r,s,a,"next",e)}function a(e){Ge(o,i,r,s,a,"throw",e)}s(void 0)}))}}function Ve(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function Ue(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var We=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),Ue(this,"documents",[]),Ue(this,"currentDocumentIndex",-1),Ue(this,"state",void 0),Ue(this,"renderService",void 0),Ue(this,"selectionService",void 0),Ue(this,"logger",void 0),Ue(this,"metadata",null),Ue(this,"shown",!1),Ue(this,"selectedItem",null),Ue(this,"selectedItemDocIds",null),Ue(this,"selectedItemDocIndex",-1),Ue(this,"loadedSvgCache",new Map),this.state=new fe(this),this.selectionService=new _e,this.renderService=new Q(this.selectionService),this.logger=r.createLogger("SchEngine")}var t,n,o,s,a,c;return t=e,(n=[{key:"name",get:function(){return"SchEngine"}},{key:"comment",get:function(){return"SVG Schematic documents handler engine"}},{key:"dependencies",get:function(){return[]}},{key:"metaInfo",get:function(){return this}},{key:"events",get:function(){return["SchEngine:loadAllDocuments","SchEngine:didDocumentAttach","SchEngine:didDocumentDettach","SchEngine:didDocumentAttachError","SchEngine:beforeDocumentLoad","SchEngine:afterDocumentLoad","SchEngine:documentMove","SchEngine:documentZoom","SchEngine:documentClick","SchEngine:resetDocumentView","SchEngine:select","SchEngine:navigate","SchEngine:drawHighlight","SchEngine:clearHighlight","SchEngine:drawSelection","SchEngine:clearSelection","SchEngine:zoomToFit"]}},{key:"activeDocumentIndex",get:function(){return this.currentDocumentIndex}},{key:"allDocuments",get:function(){return this.documents}},{key:"bus",get:function(){return r.bus}},{key:"setup",value:function(e){return this.state.goToSetup(e)}},{key:"showView",value:function(e){var t=this;return new Promise((function(n,i){t.state.goToAttach(e).then((function(e){return t.state.goToShow()})).then((function(e){return n()})).catch((function(e){return i(e)}))}))}},{key:"showDocument",value:(c=He(regeneratorRuntime.mark((function e(t){var n;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.logger.LogDebug("Show for id: "+t),e.prev=1,e.next=4,this.setActiveDocumentById(t);case 4:if(n=e.sent,this.renderService.attach(n),!this.shown){e.next=13;break}return e.next=9,this.renderService.setPosition(n);case 9:return e.next=11,this.renderService.render(n);case 11:return e.next=13,this.doSelectItem();case 13:e.next=18;break;case 15:return e.prev=15,e.t0=e.catch(1),e.abrupt("return",Promise.reject(e.t0));case 18:case"end":return e.stop()}}),e,this,[[1,15]])}))),function(e){return c.apply(this,arguments)})},{key:"hideView",value:function(){this.state.goToClose()}},{key:"resetView",value:function(){this.renderService.reset()}},{key:"enableSelection",value:function(e){this.selectionService.changeState(e)}},{key:"doSetup",value:function(e){var t=this;this.logger.LogDebug("To SETUP state");var n=e.response;if(!n)throw new Error("Response is empty");var i=this.getDocumentsFromStorage(n.storage);if(n&&n.metadata){this.metadata=n.metadata,this.renderService.setMetadata(n.metadata);var r=n.metadata.channels,o=n.metadata.schDocuments?n.metadata.schDocuments:[];r?this.setupChannels(i,o,r,n.storage):this.setupDocuments(i,o),this.selectionService.setup(n.metadata)}i.forEach((function(e){t.logger.LogError("Could nou found metadata info for document [".concat(e.name,"].")),e.order=t.documents.length,t.documents.push(e),t.documents.push(e)})),this.bus.once("SchEngine:loadAllDocuments",(function(e){return t.loadAllDocuments(e)}))}},{key:"doAttachToWorkspace",value:function(e){this.logger.LogDebug("To ATTACH_TO_WORKSPACE state"),e.setAttribute("data-view-id","schSvgView"),this.renderService.attachTo(e)}},{key:"doShow",value:function(){var e=this;return new Promise((function(t,n){if(e.logger.LogDebug("To SHOW state"),e.shown=!0,0!==e.allDocuments.length){if(e.selectedItem){var i=-1===e.currentDocumentIndex?0:e.currentDocumentIndex,r=e.documents[i].uniqueId;e.selectedItemDocIds&&e.selectedItemDocIds.find((function(e){return e===r}))?e.selectedItemDocIndex=i:e.currentDocumentIndex=e.selectedItemDocIndex}var o=-1===e.currentDocumentIndex?0:e.currentDocumentIndex;e.showDocument(e.documents[o].uniqueId).then((function(e){return t()})).catch((function(e){return n(e)}))}else e.logger.LogWarn("Any document to show")}))}},{key:"doClose",value:function(){var e;this.logger.LogDebug("To CLOSE state"),null===(e=this.renderService)||void 0===e||e.saveState(),this.shown=!1}},{key:"definePreviewUrlProperty",value:function(e,t,n){Object.defineProperty(e,"previewUrl",{get:function(){var e,i;return null!==(e=null===(i=t.files.find((function(e){return"Preview"===e.fileType&&e.originalName===n})))||void 0===i?void 0:i.dataFileUrl)&&void 0!==e?e:""}})}},{key:"getDocumentsFromStorage",value:function(e){var t,n=this;return(null!==(t=null==e?void 0:e.files.filter((function(e){return"SchSvg"===e.fileType})))&&void 0!==t?t:[]).map((function(t,r){var o=e.files.filter((function(e){return"PartMetadata"===e.fileType&&e.originalName===t.originalName})).map((function(e){return{fileType:e.fileType,fileName:e.originalName}})),s={};return s.order=r,s.id=r.toString(),s.uniqueId=r.toString(),s.channelId=0,s.loadState=i.IDLE,s.name=t.originalName,s.displayName=t.originalName,s.renderData=null,s.errorState=null,s.fileData={fileType:t.fileType,fileName:t.originalName},s.metadataFilesData=o,s.toString=function(){return"[".concat(s.id,"] ").concat(s.name," [").concat(s.loadState,"]")},n.definePreviewUrlProperty(s,e,s.fileData.fileName),s}))}},{key:"createBrokenDocument",value:function(e,t,n,r,o,s){this.logger.LogError("Cannot find data file for: [".concat(o,":").concat(t,"]."));var a={};return a.order=e,a.id=t,a.uniqueId=n,a.channelId=r,a.previewUrl="./images/warning.svg",a.loadState=i.IDLE,a.name=o,a.displayName=s,a.renderData=null,a.errorState=new Error("Cannot find document"),a}},{key:"getDataDocument",value:function(e,t){var n,i=e.findIndex((function(e){return e.name==t}));return i>=0&&(n=e[i],e.splice(i,1)),n}},{key:"setupDocuments",value:function(e,t){var n=this;t.forEach((function(t,i){var r,o=n.getDataDocument(e,t.fileName);o?(r=o,o.id=t.id,o.uniqueId=t.id,o.order=i,o.displayName=t.originalFileName||o.displayName):r=n.createBrokenDocument(i,t.id,t.id,0,t.originalFileName,t.originalFileName),n.documents.push(r)}))}},{key:"setupChannels",value:function(e,t,n,i){var r=this,o=n.reduce((function(e,t){var n=e.get(t.schId);return n||(n=[],e.set(t.schId,n)),n.push(t),e}),new Map);Array.from(o.keys()).forEach((function(n){var s=t.find((function(e){return e.id==n}));if(s){var a=o.get(n);if(a){var c=r.getDataDocument(e,s.fileName);a.forEach((function(e,t){var n;if(c)(n=Object.assign({},c)).id=s.id,n.channelId=e.id,n.uniqueId=Object(ke.a)(s.id,e.id),n.order=t,n.displayName=r.formatChannelName(s.originalFileName||c.displayName,e.name),r.definePreviewUrlProperty(n,i,n.fileData.fileName);else{var o=r.formatChannelName(s.originalFileName,e.name);n=r.createBrokenDocument(t,s.id,Object(ke.a)(s.id,e.id),e.id,s.originalFileName,o)}r.documents.push(n)}))}}}))}},{key:"formatChannelName",value:function(e,t){var n=e;return e.split(".").length>1&&(n=e.split(".").slice(0,-1).join(".")),"".concat(n,"(").concat(t,")")}},{key:"setActiveDocumentById",value:function(e){var t=this;return new Promise((function(n,o){if(e){var s=t.getDocumentIndex(e);if(s<0||s>=t.documents.length)o("Document index is out of range.");else{var a=t.documents[s];switch(t.currentDocumentIndex=s,a.loadState){case i.IDLE:r.bus.emit("SchEngine:beforeDocumentLoad",a),a.loadState=i.LOAD,t.loadDocument(a).then((function(e){r.bus.emit("SchEngine:afterDocumentLoad",a),n(a)})).catch((function(e){return o(e)}));break;case i.LOAD:r.bus.emit("SchEngine:beforeDocumentLoad",a),r.bus.on("SchEngine:afterDocumentLoad",(function(){return n(a)}));break;default:n(a)}}}else o("Document id is undefined.")}))}},{key:"loadAllDocuments",value:(a=He(regeneratorRuntime.mark((function e(t){var n,r,o,s,a=this;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Object(ze.a)(100);case 2:for(t=null!==(n=t)&&void 0!==n?n:this.documents.length,r=this.documents.filter((function(e,t){return a.documents.findIndex((function(t){return t.id===e.id}))===t})),o=0;o<r.length&&o<t;o++)(s=r[o])&&s.loadState===i.IDLE&&(s.loadState=i.LOAD,this.loadDocument(s));case 5:case"end":return e.stop()}}),e,this)}))),function(e){return a.apply(this,arguments)})},{key:"loadDocument",value:(s=He(regeneratorRuntime.mark((function e(t){var n,o,s,a,c,u,h,l,d,f,v,p,m,g,y,b=this;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=r.response.storage,o=function(e){return b.documents.filter((function(t){return t.loadState!==i.READY&&t.fileData&&t.fileData.fileName===e})).length},!t.errorState){e.next=5;break}return t.loadState=i.READY,e.abrupt("return");case 5:if(e.prev=5,s=t.fileData,a=s.fileName,c=s.fileType,h=!1,!this.loadedSvgCache.has(a)){e.next=17;break}if(t.loadState=i.READY,l=this.loadedSvgCache.get(a),o(a)||this.loadedSvgCache.delete(a),l){e.next=14;break}throw new Error("Cached reneder data is an empty");case 14:u=l,e.next=36;break;case 17:return e.next=19,n.documentLoader.loadDocument(a,c);case 19:if(d=e.sent,t.loadState=i.READY,f=o(a),!d.bodyUsed){e.next=30;break}if(v=this.loadedSvgCache.get(a),f||this.loadedSvgCache.delete(a),v){e.next=27;break}throw new Error("Cached reneder data is an empty");case 27:u=v,e.next=36;break;case 30:return e.next=32,d.text();case 32:p=e.sent,u=(new DOMParser).parseFromString(p,"text/xml"),h=!0,f&&this.loadedSvgCache.set(a,u);case 36:if(t.renderData=u,m=u.documentElement){e.next=40;break}throw new Error("Document is empty.");case 40:m.hasAttribute("data-doc-id")&&(g=m.getAttribute("data-doc-id"),t.id&&g!==t.id&&this.logger.LogError("Document meta id [".concat(t.id,"] is not equals id [").concat(g,"]"))),h&&(y={documentId:t.id,node:t.renderData.documentElement.cloneNode(!0)},this.selectionService.setupBounds(y),y.node=null),e.next=48;break;case 44:e.prev=44,e.t0=e.catch(5),t.loadState=i.READY,t.errorState=t.errorState||e.t0;case 48:case"end":return e.stop()}}),e,this,[[5,44]])}))),function(e){return s.apply(this,arguments)})},{key:"onSelect",value:function(e){var t=this;return new Promise((function(n,i){var r;if(null!=(null===(r=e)||void 0===r?void 0:r.isPrimitiveContainer)&&null!=e.isPrimitiveContainer&&!1===e.isPrimitiveContainer&&(e=null),t.selectedItem=null,t.selectedItemDocIds=null,t.selectedItemDocIndex=-1,e){var o=e.native,s=t.getItemDocumentIds(o);if(0===s.length)return void t.doSelectItem();var a=e;a&&((a=function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Be(Object(n),!0).forEach((function(t){Ue(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Be(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({},a)).fit=!(t.shown&&"SchEngine"===e.senderId)),t.selectedItem=a,t.selectedItemDocIds=s;var c=o.documentId;if(c||(!(c=t.activeDocumentIndex>-1?t.documents[t.activeDocumentIndex].uniqueId:null)||s.indexOf(c)<0)&&(c=s[0]),!c)return;var u=t.getDocumentIndex(c);t.selectedItemDocIndex=u,t.shown&&t.currentDocumentIndex===u?t.doSelectItem().catch((function(e){i(e)})):t.shown&&t.currentDocumentIndex!==u?t.showDocument(c).catch((function(e){i(e)})):t.setActiveDocumentById(c).catch((function(e){i(e)}))}else t.doSelectItem().catch((function(e){i(e)}))}))}},{key:"getItemDocumentIds",value:function(e){var t=this,n=[];if(!e)return n;if(e.schDocId){var i=e.channel;if(!i&&this.activeDocumentIndex>-1){var r=this.documents[this.activeDocumentIndex];e.schDocId===r.id&&(i=r.channelId)}var o=Object(ke.a)(e.schDocId,i);n.push(o),e.subParts&&e.subParts.forEach((function(e){var i=e.schDocId;!i||n.indexOf(i)>=0||t.documents.filter((function(e){return e.id===i})).forEach((function(e){n.push(e.uniqueId)}))}))}else if(e.primitives){var s=this.metadata.primitives;e.primitives.forEach((function(e){var i=s[e];if(i){var r=i.schDocId;!r||n.indexOf(r)>=0||t.documents.filter((function(e){return e.id===r})).forEach((function(e){n.push(e.uniqueId)}))}}))}return n.filter((function(e,t,n){return n.indexOf(e)===t}))}},{key:"doSelectItem",value:function(){var e=this;return new Promise((function(t){setTimeout((function(){if(r.bus.emit("SchEngine:clearHighlight"),e.selectedItem){var n=e.selectedItem,i=[];"component"===n.name?i.push(n.native):"net"===n.name?n.native.primitives&&(i=n.native.primitives.map((function(t){return e.metadata.primitives[t]})).filter((function(t){return e.selectionService.canSelect(t)}))):r.bus.emit("SchEngine:clearSelection",{update:!1}),i.length>0&&(r.bus.emit("SchEngine:clearSelection",{update:!0}),setTimeout((function(){r.bus.emit("SchEngine:drawSelection",{items:i,fit:n.fit}),n.fit=!1})))}else r.bus.emit("SchEngine:clearSelection",{update:!1});t()}),0)}))}},{key:"getDocumentIndex",value:function(e){var t=this.documents.findIndex((function(t){return t.uniqueId===e}));return-1==t&&(t=this.documents.findIndex((function(t){return t.id===e}))),t}}])&&Ve(t.prototype,n),o&&Ve(t,o),Object.defineProperty(t,"prototype",{writable:!1}),e}(),Fe={type:"Engine",name:"SchEngineModule",description:"Presents schematic documents engine module",create:function(){return new We}};window.__CORE__&&window.__CORE__.addModule(Fe)}});