!function(e){function t(t){for(var r,o,s=t[0],c=t[1],u=t[2],d=0,f=[];d<s.length;d++)o=s[d],Object.prototype.hasOwnProperty.call(i,o)&&i[o]&&f.push(i[o][0]),i[o]=0;for(r in c)Object.prototype.hasOwnProperty.call(c,r)&&(e[r]=c[r]);for(l&&l(t);f.length;)f.shift()();return a.push.apply(a,u||[]),n()}function n(){for(var e,t=0;t<a.length;t++){for(var n=a[t],r=!0,s=1;s<n.length;s++){var c=n[s];0!==i[c]&&(r=!1)}r&&(a.splice(t--,1),e=o(o.s=n[0]))}return e}var r={},i={59:0},a=[];function o(t){if(r[t])return r[t].exports;var n=r[t]={i:t,l:!1,exports:{}};return e[t].call(n.exports,n,n.exports,o),n.l=!0,n.exports}o.m=e,o.c=r,o.d=function(e,t,n){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(e,t){if(1&t&&(e=o(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(o.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)o.d(n,r,function(t){return e[t]}.bind(null,r));return n},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="";var s=window.webpackJsonp=window.webpackJsonp||[],c=s.push.bind(s);s.push=t,s=s.slice();for(var u=0;u<s.length;u++)t(s[u]);var l=c;a.push([1158,2]),n()}({1158:function(e,t,n){e.exports=n(1187)},1187:function(e,t,n){"use strict";n.r(t);var r=n(20),i=n(7),a=n(15),o=n(28);function s(e){return(s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function c(e,t,n,r,i,a,o){try{var s=e[a](o),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,i)}function u(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function l(e,t){return(l=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function d(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=p(e);if(t){var i=p(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return f(this,n)}}function f(e,t){if(t&&("object"===s(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return h(e)}function h(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function p(e){return(p=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function y(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var v={where:function(e){return["Show"===e.type]},to:"SHOW"},m={where:function(e){return["Error"===e.type]},to:"CRASHED",error:!0},g={IDLE:[{where:function(e){return["Setup"===e.type]},to:"SETUP"}],SETUP:[{where:function(e){return["SetupComplete"===e.type]},to:"SETUP_COMPLETED"},m],SETUP_COMPLETED:[{where:function(e){return["Init"===e.type]},to:"INIT"},m],INIT:[{where:function(e){return["InitComplete"===e.type]},to:"INIT_COMPLETED"},m],INIT_COMPLETED:[{where:function(e){return["Render"===e.type]},to:"RENDER"},m],RENDER:[{where:function(e){return["RenderComplete"===e.type]},to:"RENDER_COMPLETED"},m],RENDER_COMPLETED:[v,m],SHOW:[v,m]},b=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&l(e,t)}(f,e);var t,n,r,i,a,s=d(f);function f(e){var t;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,f),y(h(t=s.call(this,"IDLE",g)),"engine",void 0),y(h(t),"errorState",null),t.engine=e,t.onSetup=t.onSetup.bind(h(t)),t.onInit=t.onInit.bind(h(t)),t.onRender=t.onRender.bind(h(t)),t.onShow=t.onShow.bind(h(t)),t.on("SETUP",t.onSetup),t.on("INIT",t.onInit),t.on("RENDER",t.onRender),t.on("SHOW",t.onShow),t}return t=f,(n=[{key:"goToSetup",value:function(e){var t=this;return new Promise((function(n,r){t.dispatch({type:"Setup",core:e})||"SETUP"===t.state?(t.on("SETUP_COMPLETED",(function(){n()})),t.on("CRASHED",(function(e){t.errorState=e,r(t.errorState)}))):"CRASHED"===t.state?r(t.errorState):n()}))}},{key:"goToInit",value:function(e){var t=this;return new Promise((function(n,r){t.dispatch({type:"Init",document:e})||"INIT"===t.state?(window.__CORE__.bus.emit("PcbEngine:beforeDocumentInit",e),t.on("INIT_COMPLETED",(function(){window.__CORE__.bus.emit("PcbEngine:afterDocumentInit"),n()})),t.on("CRASHED",(function(e){t.errorState=e,r(t.errorState)}))):"CRASHED"===t.state?r(t.errorState):n()}))}},{key:"goToRender",value:function(e){var t=this;return new Promise((function(n,r){t.dispatch({type:"Render",document:e})||"RENDER"===t.state?(window.__CORE__.bus.emit("PcbEngine:beforeImportPCB",e),t.on("RENDER_COMPLETED",(function(){window.__CORE__.bus.emit("PcbEngine:afterImportPCB",e),n()})),t.on("CRASHED",(function(e){t.errorState=e,r(t.errorState)}))):"CRASHED"===t.state?r(t.errorState):n()}))}},{key:"goToShow",value:function(e,t){var n=this;return new Promise((function(r,i){n.dispatch({type:"Show",workspace:e,renderMode:t})||"SHOW"===n.state?r():i("Cannot show. Wrong state [".concat(n.state,"]"))}))}},{key:"nextTick",value:function(e){setTimeout((function(){e()}))}},{key:"onSetup",value:function(e){var t=this;try{var n=e.core;this.engine.doSetup(n),this.nextTick((function(){return t.dispatch({type:"SetupComplete"})}))}catch(e){this.nextTick((function(){return t.dispatch(new o.a(e.message,e))}))}}},{key:"onInit",value:(i=regeneratorRuntime.mark((function e(t){var n=this;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.engine.doInit(t.document);case 3:this.dispatch({type:"InitComplete"}),e.next=9;break;case 6:e.prev=6,e.t0=e.catch(0),this.nextTick((function(){return n.dispatch(new o.a(e.t0.message,e.t0))}));case 9:case"end":return e.stop()}}),e,this,[[0,6]])})),a=function(){var e=this,t=arguments;return new Promise((function(n,r){var a=i.apply(e,t);function o(e){c(a,n,r,o,s,"next",e)}function s(e){c(a,n,r,o,s,"throw",e)}o(void 0)}))},function(e){return a.apply(this,arguments)})},{key:"onRender",value:function(e){var t=this;try{this.engine.doRender(e.document),this.nextTick((function(){return t.dispatch({type:"RenderComplete"})}))}catch(e){this.nextTick((function(){return t.dispatch(new o.a(e.message,e))}))}}},{key:"onShow",value:function(e){this.engine.doShow(e.workspace,e.renderMode)}}])&&u(t.prototype,n),r&&u(t,r),Object.defineProperty(t,"prototype",{writable:!1}),f}(a.a),w=n(202);function k(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null==n)return;var r,i,a=[],o=!0,s=!1;try{for(n=n.call(e);!(o=(r=n.next()).done)&&(a.push(r.value),!t||a.length!==t);o=!0);}catch(e){s=!0,i=e}finally{try{o||null==n.return||n.return()}finally{if(s)throw i}}return a}(e,t)||function(e,t){if(!e)return;if("string"==typeof e)return S(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return S(e,t)}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function S(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function P(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function L(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var O=function(){function e(t,n,i){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),L(this,"scene",void 0),L(this,"materialId",void 0),L(this,"logger",void 0),L(this,"renderMode",void 0),this.scene=t,this.materialId=i,this.renderMode=n,this.logger=r.a.createLogger("PadAppearance_"+n)}var t,n,a;return t=e,(n=[{key:"set",value:function(e,t){try{var n=this.scene.getBoundingBoxForItem(e),r=this.getSizeAndPosition(n),a=i.Uni.createRectangle(r.x,r.y,r.radius,r.radius,this.materialId,[1,0],r.radius/2,r.z),o=new i.NodeContainer;return o.unis.push(a),this.scene.addNode(t,o)}catch(e){return"string"==typeof e?this.logger.LogError(e):this.logger.LogError("Set mark.",e),null}}},{key:"getSizeAndPosition",value:function(e){var t=k(e,6),n=t[0],r=t[1],i=t[2],a=t[3],o=t[4];return{x:n+(a-n)/2,y:r+(o-r)/2,z:[i-.005,t[5]+.005],radius:.4*Math.min(a-n,o-r)}}}])&&P(t.prototype,n),a&&P(t,a),Object.defineProperty(t,"prototype",{writable:!1}),e}(),E=n(306);function M(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return D(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return D(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,o=!0,s=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return o=e.done,e},e:function(e){s=!0,a=e},f:function(){try{o||null==n.return||n.return()}finally{if(s)throw a}}}}function D(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function R(e,t,n,r,i,a,o){try{var s=e[a](o),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,i)}function I(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function N(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var C=function(){function e(t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),N(this,"scene",void 0),N(this,"padAppearance",void 0),N(this,"logger",void 0),N(this,"pinPadMap",new Map),this.checkConsructorArguments(t,n),this.padAppearance=t,this.scene=n,this.logger=r.a.createLogger("ComponentPadAppearance")}var t,n,a,o,s;return t=e,(n=[{key:"setAppearancePadComponents",value:function(e,t){var n=this;if(this.scene){var r=new Map,i=new Map,a=new Map;try{var o=e.getLayers(),s=e.getLayers().filter((function(e){return"Pad Holes"===e.searchName||"Via Holes"===e.searchName})).map((function(e){return e.id}));t.forEach((function(e){var t,n=null===(t=E.a.instance.getChildPads(e))||void 0===t?void 0:t.find((function(e){return"1"===e.name}));n&&n.pcbId&&(r.set(n.pcbId,e),i.set(n.pcbId,n),a.has(e.layerId)||a.set(e.layerId,o.find((function(t){return t.metaId===e.layerId}))))}));var c=this.scene.getNodeItemsByIds(Array.from(r.keys()));if(!c)return;c.forEach((function(e){if(e){var t=e.GetId(),o=r.get(t),c=i.get(t);if(o&&c)try{var u,l=a.get(o.layerId);if(!l)return;var d=null!==(u=n.isSpecialHoleLayer(e,s))&&void 0!==u?u:l.id,f=n.padAppearance.set(e,d);if(!f)return;var h=f.GetId();c.customNodes||(c.customNodes=[]),c.customNodes.push(h),n.pinPadMap.set(h,c)}catch(e){n.logger.LogError("Failed set pad appearance for component ".concat(o.designator,"."),e)}}}))}finally{r.clear(),i.clear(),a.clear()}}}},{key:"setVisibleAppearances",value:(o=regeneratorRuntime.mark((function e(t){var n;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if((n=Array.from(this.pinPadMap.keys())).length){e.next=3;break}return e.abrupt("return");case 3:try{this.scene.setNodeItemsVisibility(n,t)}catch(e){this.logger.LogError("Set Visible = ".concat(t," for appearances."),e)}case 4:case"end":return e.stop()}}),e,this)})),s=function(){var e=this,t=arguments;return new Promise((function(n,r){var i=o.apply(e,t);function a(e){R(i,n,r,a,s,"next",e)}function s(e){R(i,n,r,a,s,"throw",e)}a(void 0)}))},function(e){return s.apply(this,arguments)})},{key:"clearAppearance",value:function(){var e=Array.from(this.pinPadMap.keys()),t=this.scene.getNodeItemsByIds(e);if(t){var n,r=M(t);try{for(r.s();!(n=r.n()).done;){var i=n.value;try{var a=i.GetId(),o=this.pinPadMap.get(a);if(o&&o.customNodes){var s=o.customNodes.indexOf(a);s>=0&&o.customNodes.splice(s,1)}this.scene.deleteItem(i)}catch(e){this.logger.LogError("Failed to remove nodeItem for Pad appearance",e)}}}catch(e){r.e(e)}finally{r.f()}}this.pinPadMap.clear()}},{key:"setVisibleComponents",value:function(e,t){try{var n=E.a.instance;e||(e=E.a.instance.components);var r=e.flatMap((function(e){return n.getChildPrimitives(e)})).filter((function(e){return n.getObjectId(e)!==i.ObjectId.Pad})).filter((function(e){return e&&e.pcbId})).map((function(e){return e.pcbId}));try{this.scene.setNodeItemsVisibility(r,t)}catch(e){this.logger.LogError("Set nodes visibility",e)}}catch(e){this.logger.LogError("Failed to remove nodeItem for Pad appearance.",e)}}},{key:"checkConsructorArguments",value:function(e,t){if(!(e.renderMode===i.RenderMode.Render2D&&t instanceof i.Scene2D||e.renderMode===i.RenderMode.Render3D&&t instanceof i.Scene3D)){var n="Inconsistency between the types of the render mode and the scene.\nRenderMode=".concat(e.renderMode,", Scene=").concat(t);throw this.logger.LogError(n),new Error(n)}}},{key:"isSpecialHoleLayer",value:function(e,t){if(e&&this.padAppearance.renderMode===i.RenderMode.Render2D)for(var n=0;n<e.GetLayersCount();n++){var r=e.GetLayerGeometry(n).GetLayerIndex();if(t.indexOf(r)>=0)return r}return null}}])&&I(t.prototype,n),a&&I(t,a),Object.defineProperty(t,"prototype",{writable:!1}),e}();function x(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function j(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var T=[0,0,0,230],A=[0,0,0,230],V=function(){function e(t,n,a){var o=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),j(this,"componentPadAppearance2d",void 0),j(this,"componentPadAppearance3d",void 0),j(this,"logger",void 0),this.logger=r.a.createLogger("PadAppearanceManager"),a==i.RenderMode.Render3D?(this.componentPadAppearance2d=this.createAppearance(t,T,i.RenderMode.Render2D),this.componentPadAppearance3d=this.createAppearance(n,A,i.RenderMode.Render3D)):(this.componentPadAppearance3d=this.createAppearance(n,A,i.RenderMode.Render3D),this.componentPadAppearance2d=this.createAppearance(t,T,i.RenderMode.Render2D)),r.a.bus.on("PcbEngine:changedRenderMode",(function(e){return o.setRenderMode(e)}))}var t,n,a;return t=e,(n=[{key:"setPadAppearance",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;n||(n=E.a.instance.components);try{this.componentPadAppearance2d.setAppearancePadComponents(e,n),this.componentPadAppearance3d.setAppearancePadComponents(e,n),this.setRenderMode(t)}catch(e){this.logger.LogError("Failed set pad appearance for components",e)}}},{key:"clearPadAppearance",value:function(){this.componentPadAppearance2d.clearAppearance(),this.componentPadAppearance3d.clearAppearance()}},{key:"setRenderMode",value:function(e){e==i.RenderMode.Render2D?(this.componentPadAppearance3d.setVisibleAppearances(!1),this.componentPadAppearance2d.setVisibleAppearances(!0)):(this.componentPadAppearance2d.setVisibleAppearances(!1),this.componentPadAppearance3d.setVisibleAppearances(!0))}},{key:"createAppearance",value:function(e,t,n){e.setMaterials(e.getMaterials());var r=e.addMaterial(new i.Material(t,i.HatchStyle.None)),a=new O(e,n,r);return new C(a,e)}}])&&x(t.prototype,n),a&&x(t,a),Object.defineProperty(t,"prototype",{writable:!1}),e}(),_=n(368),B=n(242),F=n(307),H=n(52),G=n(46),K=n(23);function U(e){return function(e){if(Array.isArray(e))return W(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||function(e,t){if(!e)return;if("string"==typeof e)return W(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return W(e,t)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function W(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function z(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Q(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var Z=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),Q(this,"layerManager",void 0),Q(this,"layers",[]),Q(this,"lastOnceLayer",null),Q(this,"currentLayerState",null),this.layerManager=t}var t,n,r;return t=e,(n=[{key:"setOnceLayer",value:function(e){var t;if("string"==typeof e){if(!(t=this.layers.find((function(t){return t.name===e}))))return;this.currentLayerState||(this.currentLayerState=this.layers.map((function(e){return Object.assign({},e)})))}else t=e;if(t){this.lastOnceLayer=t;var n=this.lastOnceLayer.name;this.layers.forEach((function(e){return e.isVisible=e.name==n||e.name==K.b.BackgroundLayer})),this.updateLayersVisibility()}}},{key:"nextOnceLayer",value:function(){var e,t=this.getSortedLayers();if(this.lastOnceLayer&&this.currentLayerState){var n=this.lastOnceLayer.name,r=t.findIndex((function(e){return e.name==n}));r==t.length-1&&(r=-1),e=t.find((function(e,t){return!e.ignored&&t>r}))}else this.currentLayerState=this.layers.map((function(e){return Object.assign({},e)})),e=t.find((function(e){return e.isVisible&&!e.ignored}));return e&&this.setOnceLayer(e),e}},{key:"prevOnceLayer",value:function(){var e,t=this.getSortedLayers().reverse();if(this.lastOnceLayer&&this.currentLayerState){var n=t.indexOf(this.lastOnceLayer);n==t.length-1&&(n=-1),e=t.find((function(e,t){return!e.ignored&&t>n}))}else this.currentLayerState=this.layers.map((function(e){return Object.assign({},e)})),e=t.find((function(e){return e.isVisible&&!e.ignored}));return e&&this.setOnceLayer(e),e}},{key:"resetOnceLayer",value:function(){this.lastOnceLayer=null,this.currentLayerState&&(this.layers=this.currentLayerState,this.updateLayersVisibility(),this.currentLayerState=null)}},{key:"updateLayersVisibility",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this.layerManager.setLayers(this.layers,e)}},{key:"getSortedLayers",value:function(){var e=[];return this.layerManager.getGroupedLayers().forEach((function(t){return e.push.apply(e,U(t))})),e}}])&&z(t.prototype,n),r&&z(t,r),Object.defineProperty(t,"prototype",{writable:!1}),e}();function X(e){return function(e){if(Array.isArray(e))return q(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||function(e,t){if(!e)return;if("string"==typeof e)return q(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return q(e,t)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function q(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function $(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Y(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var J,ee,te=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),Y(this,"scene",void 0),Y(this,"onceLayerManager",void 0),Y(this,"holeConnecterLayerKins",[K.a.Signal,K.a.Solder,K.a.Plane]),this.scene=t,this.onceLayerManager=new Z(this)}var t,n,i;return t=e,(n=[{key:"flipped",get:function(){return this.scene.flipped}},{key:"viewType",get:function(){return this.flipped?"bottom":"top"}},{key:"layers",get:function(){return this.onceLayerManager.layers},set:function(e){this.onceLayerManager.layers=e}},{key:"setLayers",value:function(e,t){this.scene.renderOptions=this.createRenderOptions(this.scene.layers,t,e),this.layers=e,this.emitLayerEvent("setLayer",e,!1)}},{key:"resetLayers",value:function(){this.layers=this.getLayers(!1),this.setLayers(this.layers,!1),this.emitLayerEvent("resetLayer",this.layers,!1)}},{key:"getGroupedLayers",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],t=function(e){return"Copper"==e?1:"Solder Mask"==e?2:"Paste Mask"==e?3:"Silkscreen"==e?4:"Mechanical"==e?5:"Other"==e?6:0},n=[],r=this.getLayers(e),i=X(new Set(r.map((function(e){return e.layerGroup})))).sort();return i.filter((function(e){return"none"!==e&&"System Colors"!==e})).sort((function(e,n){return t(e)-t(n)})).forEach((function(e){var t=r.filter((function(t){return!t.ignored&&t.layerGroup===e}));"Mechanical"===e&&(t=t.map((function(e){return{layer:e,stackIndex:e.stackIndex?e.stackIndex:1e3}})).sort((function(e,t){return e.stackIndex-t.stackIndex})).map((function(e){return e.layer}))),t.length>0&&n.push(t)})),n}},{key:"setTopView",value:function(){this.flipped&&(this.flipBoard(),this.emitLayerEvent("setTopView",this.layers,!1))}},{key:"setBottomView",value:function(){this.flipped||(this.flipBoard(),this.emitLayerEvent("setBottomView",this.layers,!1))}},{key:"setOnceLayer",value:function(e){this.onceLayerManager.setOnceLayer(e),this.emitLayerEvent("setOnceLayer",e)}},{key:"nextOnceLayer",value:function(){var e=this.onceLayerManager.nextOnceLayer();return this.emitLayerEvent("setOnceLayer",e),e}},{key:"prevOnceLayer",value:function(){var e=this.onceLayerManager.prevOnceLayer();return this.emitLayerEvent("setOnceLayer",e),e}},{key:"resetOnceLayer",value:function(){this.onceLayerManager.resetOnceLayer(),this.emitLayerEvent("resetOnceLayer",null,!1)}},{key:"emitLayerEvent",value:function(e,t){var n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],i="LayerManager:changedLayers",a={eventType:e,data:t,needLayersChange:n};r.a.bus.emit(i,a)}},{key:"defineLayerGroup",value:function(e,t){return 0!=(e&K.a.Signal)||0!=(e&K.a.Plane)?"Copper":0!=(e&K.a.Paste)?"Paste Mask":0!=(e&K.a.Overlay)?"Silkscreen":0!=(e&K.a.Solder)?"Solder Mask":0!=(e&K.a.Mechanical)?"Mechanical":0!=(e&K.a.Other)?"Other":0!=(e&K.a.System)?"System Colors":0!=(e&K.a.Dielectric)?"Dielectric":t}},{key:"addSelectionRenderOptions",value:function(e,t){var n=t.length-t.filter((function(e){return e.name==H.b.SelectionLayerName})).length,r=e.map((function(e){var r="SL:"+t[e.layer].name;return new G.h(e.layer+n,r)}));e.push(new G.h(t.length-2,H.b.SelectionLayerName)),e.push.apply(e,X(r)),e.push(new G.h(t.length-1,H.b.HighlightLayerName))}},{key:"isViaPadKind",value:function(e){return this.holeConnecterLayerKins.some((function(t){return 0!=(t&e)}))}},{key:"isVisibleViaPadLayers",value:function(e){var t=this;return e.some((function(e){return e.isVisible&&(t.isViaPadKind(e.kind)||e.searchName===K.b.MultiLayer)}))}}])&&$(t.prototype,n),i&&$(t,i),Object.defineProperty(t,"prototype",{writable:!1}),e}(),ne=te;function re(e){return(re="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function ie(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function ae(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function oe(e,t){return(oe=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function se(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=le(e);if(t){var i=le(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return ce(this,n)}}function ce(e,t){if(t&&("object"===re(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return ue(e)}function ue(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function le(e){return(le=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function de(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}!function(e){e[e.Background=0]="Background",e[e.Other=1]="Other",e[e.DrillDrawing=2]="DrillDrawing",e[e.Mechanichal=3]="Mechanichal",e[e.KeepOut=4]="KeepOut",e[e.DrillGuide=5]="DrillGuide",e[e.Plane=6]="Plane",e[e.SolderMask=7]="SolderMask",e[e.Paste=8]="Paste",e[e.Signal=9]="Signal",e[e.Current=10]="Current",e[e.Overlay=11]="Overlay",e[e.MultiLayer=12]="MultiLayer",e[e.Holes=13]="Holes",e[e.Ignored=14]="Ignored"}(J||(J={})),function(e){e[e.Bottom=0]="Bottom",e[e.Internal=1]="Internal",e[e.Top=2]="Top"}(ee||(ee={}));var fe=new Map([[K.b.BackgroundLayer,{kind:K.a.System,stackKind:J.Background}],[K.b.MultiLayer,{kind:K.a.Other,stackKind:J.MultiLayer}],[K.b.TopOverlayLayer,{kind:K.a.Overlay|K.a.Top|K.a.LayerPair,stackKind:J.Overlay}],[K.b.BottomOverlayLayer,{kind:K.a.Overlay|K.a.Bottom|K.a.LayerPair,stackKind:J.Overlay}],[K.b.TopLayer,{kind:K.a.Signal|K.a.Top,stackKind:J.Signal}],[K.b.BottomLayer,{kind:K.a.Signal|K.a.Bottom,stackKind:J.Signal}],[K.b.TopPasteLayer,{kind:K.a.Paste|K.a.Top|K.a.LayerPair,stackKind:J.Paste}],[K.b.BottomPasteLayer,{kind:K.a.Paste|K.a.Bottom|K.a.LayerPair,stackKind:J.Paste}],[K.b.TopSolderLayer,{kind:K.a.Solder|K.a.Top|K.a.LayerPair,stackKind:J.SolderMask}],[K.b.BottomSolderLayer,{kind:K.a.Solder|K.a.Bottom|K.a.LayerPair,stackKind:J.SolderMask}],[K.b.PadHolesLayer,{kind:K.a.System,stackKind:J.Holes}],[K.b.ViaHolesLayer,{kind:K.a.System,stackKind:J.Holes}],[K.b.DrillGuideLayer,{kind:K.a.Other,stackKind:J.DrillGuide}],[K.b.KeepOutLayer,{kind:K.a.Other,stackKind:J.KeepOut}],[K.b.DrillDrawingLayer,{kind:K.a.Other,stackKind:J.DrillDrawing}],[K.b.SelectionsLayer,{kind:K.a.System,stackKind:J.Ignored}],[K.b.ConnectionsLayer,{kind:K.a.System,stackKind:J.Ignored}]]),he=[[K.b.MidLayer,{kind:K.a.Signal,stackKind:J.Signal}],[K.b.InternalPlaneLayer,{kind:K.a.Signal,stackKind:J.Plane}],[K.b.MechanicalLayer,{kind:K.a.Mechanical,stackKind:J.Mechanichal}],[K.b.DielectricLayer,{kind:K.a.Dielectric,stackKind:J.Ignored}]],pe=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&oe(e,t)}(o,e);var t,n,i,a=se(o);function o(){var e;ie(this,o);for(var t=arguments.length,n=new Array(t),i=0;i<t;i++)n[i]=arguments[i];return de(ue(e=a.call.apply(a,[this].concat(n))),"logger",r.a.createLogger("NoMetadataPcbLayerManager")),e}return t=o,(n=[{key:"flipSortedLayers",value:function(e){e.reduce((function(e,t){if(!t.ignored&&t.kind!==K.a.System&&t.kind!==K.a.Other){var n=e.get(t.layerGroup);n?n.push(t):e.set(t.layerGroup,[t])}return e}),new Map).forEach((function(e){var t=e.map((function(e){return e.stackIndex}));e.forEach((function(e,n){e.stackIndex=t[t.length-n-1]}))}))}},{key:"getLayers",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return e&&this.layers.length||(this.layers=this.getBoardLayers(this.scene.layers),t&&this.flipSortedLayers(this.layers)),this.layers}},{key:"flipBoard",value:function(){this.scene.flipped=!this.scene.flipped,this.layers?(this.flipSortedLayers(this.layers),this.setLayers(this.layers,!1)):this.setLayers(this.layers,this.scene.flipped),console.log("flipBoard",this.layers.map((function(e){return e.name})).join(" | "))}},{key:"createRenderOptions",value:function(e,t,n){var r=[],i=n?this.setSystemLayers(n):this.getLayers(!1,t);this.setDefaultVisibility(i),i.forEach((function(t){t.ignored||t.isVisible&&e.filter((function(e){return e.name===t.name})).sort((function(e,t){return(Number(e.is_cutout)^Number(e.is_inverted)?0:1)-(Number(t.is_cutout)^Number(t.is_inverted)?0:1)})).forEach((function(e){return r.push(new F.a(e.index,e.name))}))})),this.addSelectionRenderOptions(r,e);var a=r.filter((function(e){return e.layer%3==0||e.layerName.startsWith("Highligh")})).reduce((function(e,t,n){return e+" | [".concat(t.layer,"] ").concat(t.layerName," ")}),"Layers to render: ");return this.logger.LogInfo(a),r}},{key:"getBoardLayers",value:function(e){var t=this,n=[B.a.SelectionLayerName,B.a.HighlightLayerName,"NoLayer"];return Array.from(new Map(e.filter((function(e){return!n.includes(e.name)})).map((function(e){return[e.name,e]}))).values()).map((function(e){var n={layer:e,kind:K.a.None,group:"Unknown",stackKind:J.Ignored,levelKind:ee.Internal,levelIndex:0,ignored:!0};return t.setBoardLayerInfo(n)})).sort((function(e,t){return e.stackKind!==t.stackKind?e.stackKind-t.stackKind:e.levelKind!==t.levelKind?e.levelKind-t.levelKind:t.levelIndex-e.levelIndex})).map((function(e,t){return{id:e.layer.index,metaId:-1,name:e.layer.name,searchName:e.layer.name,color:"none",layerGroup:e.group,isVisible:!(e.ignored||e.kind===K.a.Other||e.kind===K.a.System||e.kind===K.a.Mechanical),ignored:e.ignored,kind:e.kind,stackIndex:t}}))}},{key:"setBoardLayerInfo",value:function(e){if(e.layer.name){var t=fe.get(e.layer.name);if(t)return e.kind=t.kind,e.stackKind=t.stackKind,0!=(e.kind&K.a.Top)&&(e.levelKind=ee.Top),0!=(e.kind&K.a.Bottom)&&(e.levelKind=ee.Bottom),e.group=this.defineLayerGroup(e.kind,e.group),e.ignored=e.stackKind===J.Ignored,e;var n=0,r=he.find((function(t){var r=e.layer.name.match("".concat(t[0]," (\\d*)"));if(r&&r[0]&&"".concat(t[0]," ").concat(r[1])===r[0])return n=r[1]?Number.parseInt(r[1]):n,!0}));if(r)return e.kind=r[1].kind,e.stackKind=r[1].stackKind,e.levelIndex=n,e.group=this.defineLayerGroup(e.kind,e.group),e.ignored=e.stackKind===J.Ignored,e}return e}},{key:"setSystemLayers",value:function(e){var t=this,n=function(n){if(!e.find((function(e){return e.kind===K.a.System&&e.searchName===n}))){var r=t.layers.find((function(e){return e.searchName===n}));r&&e.push(r)}};return n(K.b.BackgroundLayer),n(K.b.ViaHolesLayer),n(K.b.PadHolesLayer),e.sort((function(e,t){return e.stackIndex-t.stackIndex}))}},{key:"setDefaultVisibility",value:function(e){var t=this.isVisibleViaPadLayers(e);e.forEach((function(e){e.kind===K.a.System&&e.searchName===K.b.BackgroundLayer&&(e.isVisible=!0),e.kind===K.a.System&&e.searchName===K.b.ViaHolesLayer&&(e.isVisible=t),e.kind===K.a.System&&e.searchName===K.b.PadHolesLayer&&(e.isVisible=t),e.searchName===K.b.MultiLayer&&t&&(e.isVisible=t)}))}}])&&ae(t.prototype,n),i&&ae(t,i),Object.defineProperty(t,"prototype",{writable:!1}),o}(te);function ye(e){return(ye="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function ve(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function me(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?ve(Object(n),!0).forEach((function(t){Le(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):ve(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function ge(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function be(e,t){return(be=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function we(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=Pe(e);if(t){var i=Pe(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return ke(this,n)}}function ke(e,t){if(t&&("object"===ye(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return Se(e)}function Se(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function Pe(e){return(Pe=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function Le(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var Oe;!function(e){e[e.topSystem=0]="topSystem",e[e.top=1]="top",e[e.middle=2]="middle",e[e.plane=3]="plane",e[e.bottom=4]="bottom",e[e.mechanical=5]="mechanical",e[e.other=6]="other",e[e.bottomSystem=7]="bottomSystem",e[e.ignored=8]="ignored",e[e.max=9]="max"}(Oe||(Oe={}));var Ee=r.a.createLogger("PcbLayerManager"),Me=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&be(e,t)}(o,e);var t,n,i,a=we(o);function o(e,t){var n;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,o),Le(Se(n=a.call(this,e)),"metaLayers",new Map),Le(Se(n),"metadataLayers",void 0),Le(Se(n),"metaProjectTypeName",void 0),n.metaProjectTypeName=t.projectTypeName,n.initMetaLayers(t.layers),n}return t=o,(n=[{key:"getLayers",value:function(){var e,t=this,n=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];if(n&&null!==(e=this.layers)&&void 0!==e&&e.length)return this.layers;this.layers=this.getBoardLayers(this.scene.layers,!1),this.IsKiCadProject()&&(this.layers=this.layers.filter((function(e){return t.metadataLayers.find((function(t){return t.searchName==e.name}))})));var r=-3;return this.metadataLayers.forEach((function(e){var n=t.layers.find((function(t){return t.name===e.searchName}));if(n)n.name=e.name,n.color=e.color,n.metaId=e.id,n.stackIndex=e.stackIndex,n.kind=e.kind,void 0!==e.isVisible&&(n.isVisible=e.isVisible),void 0!==e.ignored?n.ignored=e.ignored:void 0===e.stackIndex&&(n.ignored=!0),e.kind&&(n.layerGroup=t.getLayerGroup(n,e.kind));else{var i={id:r--,name:e.name,color:e.color,metaId:e.id,ignored:e.ignored,searchName:e.searchName,isVisible:!0,stackIndex:e.stackIndex,layerGroup:"",kind:e.kind};void 0!==e.isVisible&&(i.isVisible=e.isVisible),void 0!==e.ignored?i.ignored=e.ignored:void 0===e.stackIndex&&(i.ignored=!0),e.kind&&(i.layerGroup=t.getLayerGroup(i,e.kind)),t.layers.push(i)}})),this.layers}},{key:"flipBoard",value:function(){var e=this,t=this.scene;t.flipped=!t.flipped;var n=new Map;this.metadataLayers.slice().sort((function(e,t){return e.stackIndex-t.stackIndex})).forEach((function(t){var r=e.getLayerGroup(t,t.kind);if(r&&t.stackIndex){var i=n.get(r);i?i.push(t):n.set(r,[t])}})),n.forEach((function(e,t){if("System Colors"!==t&&"Other"!==t&&"Dielectric"!==t){var n=e.map((function(e){return e.stackIndex}));e.forEach((function(e,t){e.stackIndex=n[n.length-t-1]}))}})),this.setLayers(this.layers,!1),r.a.bus.emit("PcbEngine:flipped",this.flipped)}},{key:"createRenderOptions",value:function(e,t,n){var r=this,i=[];if((n?this.setViaPadFilter(n):this.getBoardLayers(e,t)).forEach((function(t){var n;t.ignored||t.isVisible&&(!r.metaLayers||null!==(n=r.metaLayers.get(t.searchName))&&void 0!==n&&n.stackIndex)&&e.filter((function(e){return"NoLayer"!=e.name&&t.id<=e.index&&e.index<t.id+3})).forEach((function(e){return i.push(new G.h(e.index,e.name))}))})),!i.find((function(e){return e.layerName===K.b.BackgroundLayer}))){var a=e.find((function(e){return e.name===K.b.BackgroundLayer}));a&&i.push(new G.h(a.index,a.name))}if(this.metaLayers.size>0){var o=this.metaLayers;i.sort(),i.sort((function(t,n){var r,i,a,s,c=null!==(r=null===(i=o.get(t.layerName))||void 0===i?void 0:i.stackIndex)&&void 0!==r?r:0,u=null!==(a=null===(s=o.get(n.layerName))||void 0===s?void 0:s.stackIndex)&&void 0!==a?a:0;if(c!==u)return u-c;var l=e[t.layer],d=e[n.layer];return(Number(l.is_cutout)^Number(l.is_inverted)?0:1)-(Number(d.is_cutout)^Number(d.is_inverted)?0:1)}))}else{var s={};i.reverse().forEach((function(e,t){s[e.layer]=Math.floor(t/3)})),i.sort(),i.sort((function(t,n){s[t.layer],s[n.layer];var r=e[t.layer],i=e[n.layer];return(Number(r.is_cutout)^Number(r.is_inverted)?0:1)-(Number(i.is_cutout)^Number(i.is_inverted)?0:1)}))}this.addSelectionRenderOptions(i,e);var c=i.filter((function(e){return e.layer%3==0||e.layerName.startsWith("Highligh")})).reduce((function(e,t,n){return e+" | [".concat(t.layer,"] ").concat(t.layerName," ")}),"Layers to render: ");return Ee.LogInfo(c),i}},{key:"initMetaLayers",value:function(e){var t,n=this;if(this.metadataLayers=e.filter((function(e){return e.stackIndex})),null===(t=this.metadataLayers)||void 0===t||!t.length)throw Ee.LogError("Empty metadata layers."),new Error("Empty metadata layers.");this.metadataLayers.forEach((function(e){return n.metaLayers.set(e.searchName,e)}))}},{key:"groupLayers",value:function(e){var t=["Pad Holes","Via Holes","Connections"],n=[K.b.BackgroundLayer],r=[K.b.MultiLayer,"Drill Guide","Keep-Out Layer","Drill Drawing"],i=[];i.length=Oe.max;for(var a=0;a<i.length;a++)i[a]=[];return e.forEach((function(e){t.indexOf(e.name)>=0?i[Oe.topSystem].push(e):e.name.startsWith("Top")?i[Oe.top].push(e):e.name.startsWith("Mid-Layer")?i[Oe.middle].push(e):e.name.startsWith("Internal Plane")?i[Oe.plane].push(e):e.name.startsWith("Bottom")?i[Oe.bottom].push(e):e.name.startsWith("Mechanical")?i[Oe.mechanical].push(e):r.indexOf(e.name)>=0?i[Oe.other].push(e):n.indexOf(e.name)>=0?i[Oe.bottomSystem].push(e):i[Oe.ignored].push(e)})),i}},{key:"updateGroupNames",value:function(e){var t=function(e){return"Paste"===e?"Paste Mask":"Overlay"===e?"Silkscreen":"Solder"===e?"Solder Mask":"Layer"===e?"Copper":"none"};e[Oe.mechanical].forEach((function(e){e.isVisible=!1,e.layerGroup="Mechanical"})),e[Oe.other].forEach((function(e){e.isVisible=!1,e.layerGroup="Other"})),e[Oe.middle].forEach((function(e){e.layerGroup="Copper"})),e[Oe.plane].forEach((function(e){e.layerGroup="Copper"})),e[Oe.topSystem].forEach((function(e){e.layerGroup="System Colors"})),e[Oe.bottomSystem].forEach((function(e){e.layerGroup="System Colors"})),e[Oe.top].forEach((function(e){e.layerGroup=t(e.name.replace("Top ",""))})),e[Oe.bottom].forEach((function(e){e.layerGroup=t(e.name.replace("Bottom ",""))}))}},{key:"getLayerGroup",value:function(e,t){if(0!=(t&K.a.Signal))return"Copper";if(0!=(t&K.a.LayerPair)){if(e.searchName.endsWith("Paste"))return"Paste Mask";if(e.searchName.endsWith("Overlay"))return"Silkscreen";if(e.searchName.endsWith("Solder"))return"Solder Mask"}return 0!=(t&K.a.Plane)?"Copper":0!=(t&K.a.Mechanical)?"Mechanical":0!=(t&K.a.Other)?"Other":0!=(t&K.a.System)?"System Colors":0!=(t&K.a.Dielectric)?"Dielectric":e.layerGroup}},{key:"sortTopOrBottomLayers",value:function(e,t){var n=function(n){var r=n.name.replace(e+" ","");return"Pad Master"===r?t.length:"Paste"===r?t.length-1:"Overlay"===r?t.length-2:"Solder"===r?t.length-3:"Layer"===r?t.length-4:0};return t.sort((function(e,t){return n(e)-n(t)}))}},{key:"sortLayersByIndex",value:function(e){var t=function(e){return parseInt(e.name.replace(/[^0-9\.]+/g,""))};return e.sort((function(e,n){return t(e)-t(n)}))}},{key:"sortLayers",value:function(e){e[Oe.middle]=this.sortLayersByIndex(e[Oe.middle]),e[Oe.plane]=this.sortLayersByIndex(e[Oe.plane]),e[Oe.mechanical]=this.sortLayersByIndex(e[Oe.mechanical]),e[Oe.top]=this.sortTopOrBottomLayers("Top",e[Oe.top]).reverse(),e[Oe.bottom]=this.sortTopOrBottomLayers("Bottom",e[Oe.bottom])}},{key:"getStack",value:function(e,t){var n=[],r=[];return e[Oe.top].forEach((function(e){return n.push(e)})),e[Oe.middle].forEach((function(e){return n.push(e)})),e[Oe.plane].forEach((function(e){return n.push(e)})),e[Oe.bottom].forEach((function(e){return n.push(e)})),t&&n.reverse(),e[Oe.topSystem].forEach((function(e){return r.push(e)})),n.forEach((function(e){return r.push(e)})),e[Oe.mechanical].forEach((function(e){return r.push(e)})),e[Oe.other].forEach((function(e){return r.push(e)})),e[Oe.bottomSystem].forEach((function(e){return r.push(e)})),e[Oe.ignored].forEach((function(e){return r.push(e)})),r}},{key:"getBoardLayers",value:function(e,t){var n=e.slice(0).filter((function(e){return e.index%3==0&&e.name!==H.b.SelectionLayerName&&"NoLayer"!=e.name})).map((function(e){return{id:e.index,metaId:-1,name:e.name,searchName:e.name,color:"none",layerGroup:"none",isVisible:!0,ignored:!1,kind:0,stackIndex:0}})),r=this.groupLayers(n);return r[Oe.ignored].forEach((function(e){return e.ignored=!0})),this.updateGroupNames(r),this.sortLayers(r),this.getStack(r,t)}},{key:"setViaPadFilter",value:function(e){var t=this;if(!this.isVisibleViaPadLayers(e))return e.filter((function(e){return!t.isHolesLayer(e)}));var n=e.find((function(e){return e.searchName===K.b.MultiLayer}));return n&&(n.isVisible=!0),e=this.setViaPadHolesFilter(e)}},{key:"setViaPadHolesFilter",value:function(e){var t=this,n=this.metadataLayers.filter((function(e){return t.isHolesLayer(e)}));return e=e.slice(),null==n||n.forEach((function(n){var r=e.find((function(e){return e.metaId===n.id}));if(r)r.isVisible=!0;else{var i,a,o=me(me({},n),{},{metaId:n.id,isVisible:!0});o.id=null!==(i=null===(a=t.scene.layers.find((function(e){return e.name===o.searchName})))||void 0===a?void 0:a.index)&&void 0!==i?i:-999,e.push(o)}})),e}},{key:"isHolesLayer",value:function(e){return!!e&&(e.searchName.startsWith("Pad Holes")||e.searchName.startsWith("Via Holes"))}},{key:"IsKiCadProject",value:function(){return"KiCad"==this.metaProjectTypeName}}])&&ge(t.prototype,n),i&&ge(t,i),Object.defineProperty(t,"prototype",{writable:!1}),o}(ne);function De(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var Re=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,n,i;return t=e,(n=[{key:"createLayerManager",value:function(e){var t=r.a.response.metadata;return t&&t.layers&&0!==t.layers.length?new Me(e,t):new pe(e)}}])&&De(t.prototype,n),i&&De(t,i),Object.defineProperty(t,"prototype",{writable:!1}),e}(),Ie=n(365);function Ne(e,t,n,r,i,a,o){try{var s=e[a](o),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,i)}function Ce(e){return function(){var t=this,n=arguments;return new Promise((function(r,i){var a=e.apply(t,n);function o(e){Ne(a,r,i,o,s,"next",e)}function s(e){Ne(a,r,i,o,s,"throw",e)}o(void 0)}))}}function xe(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function je(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var Te,Ae=[255,216,0,200],Ve=function(){function e(t){var n=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),je(this,"scene",void 0),je(this,"logger",void 0),je(this,"layerId",void 0),je(this,"linesNodeId",null),je(this,"selectedLinesNodeId",null),je(this,"selectedNode",null),je(this,"isSelected",!1),je(this,"renderMode",i.RenderMode.Render2D),je(this,"onSelectedItem",function(){var e=Ce(regeneratorRuntime.mark((function e(t){var r;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n.isSelected=!!t,n.clearSelection(),t&&n.addSelection(t),r=n.renderMode===i.RenderMode.Render2D,n.setVisibleUnroutedLines(r);case 5:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),this.layerId=t.layers.length-1,this.scene=t,this.logger=r.a.createLogger("UnroutedConnectionBuilder"),r.a.bus.on("PcbEngine:changedRenderMode",(function(e){return n.setRenderMode(e)})),r.a.bus.on("select",this.onSelectedItem)}var t,n,a,o,s;return t=e,(n=[{key:"addConnectionsToScene",value:(s=Ce(regeneratorRuntime.mark((function e(t){var n=this;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise((function(e,r){try{var a,o,s,c,u;n.renderMode=t;var l=E.a.instance;if(null===(a=l.primitives)||void 0===a||!a.length)return;var d=l.primitives.filter((function(e){return l.getObjectId(e)===i.ObjectId.Connection}));if(null==d||!d.length)return;n.linesNodeId=null!==(o=null===(s=n.addConnectionNodeToScene(d,n.layerId,Ae))||void 0===s?void 0:s.GetId())&&void 0!==o?o:null;var f=i.ColorHelper.toGrayscale(Ae);n.selectedLinesNodeId=null!==(c=null===(u=n.addConnectionNodeToScene(d,n.layerId,f))||void 0===u?void 0:u.GetId())&&void 0!==c?c:null;var h=t===i.RenderMode.Render2D;n.setVisibleUnroutedLines(h),e()}catch(e){n.logger.LogError("Failed add unrouted connections to scene.\n Error ".concat(e.name,": ").concat(e.message,"\n").concat(e.stack)),r(e)}})));case 1:case"end":return e.stop()}}),e)}))),function(e){return s.apply(this,arguments)})},{key:"addConnectionNodeToScene",value:function(e,t,n){var r=this;try{var a=new i.NodeContainer;return e.filter((function(e){return null!=(t=e).x&&null!=t.x1&&null!=t.y&&null!=t.y1;var t})).forEach((function(e){var t=r.createLine(e,n);a.lines.push(t)})),this.scene.addNode(t,a)}catch(e){return"string"==typeof e?this.logger.LogError(e):this.logger.LogError("Error ".concat(e.name,": ").concat(e.message,"\n").concat(e.stack)),null}}},{key:"createLine",value:function(e,t){var n=[e.x/1e6,e.y/1e6,0],r=[e.x1/1e6,e.y1/1e6,0];return new i.Line(n,r,t)}},{key:"setVisibleUnroutedLines",value:(o=Ce(regeneratorRuntime.mark((function e(t){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.linesNodeId&&this.selectedLinesNodeId){e.next=2;break}return e.abrupt("return");case 2:try{this.scene.setNodeItemsVisibility([this.linesNodeId],t&&!this.isSelected),this.scene.setNodeItemsVisibility([this.selectedLinesNodeId],t&&this.isSelected),this.invalidateScene()}catch(e){this.logger.LogError("Set Visible = ".concat(t," for unrouted net lines.\n Error ").concat(e.name,": ").concat(e.message,"\n").concat(e.stack))}case 3:case"end":return e.stop()}}),e,this)}))),function(e){return o.apply(this,arguments)})},{key:"setRenderMode",value:function(e){this.renderMode=e;var t=e===i.RenderMode.Render2D;this.setVisibleUnroutedLines(t)}},{key:"clearSelection",value:function(){try{this.selectedNode&&this.scene.removeItem(this.selectedNode)}catch(e){this.logger.LogError("Remove selected node from scene\n Error ".concat(e.name,": ").concat(e.message,"\n").concat(e.stack))}}},{key:"addSelection",value:function(e){if("net"===(null==e?void 0:e.name)&&(null==e.isPrimitiveContainer||e.isPrimitiveContainer)){var t=E.a.instance,n=e.native.primitives.map((function(e){return t.primitives[e]})).filter((function(e){return e&&t.getObjectId(e)===i.ObjectId.Connection}));null!=n&&n.length&&(this.selectedNode=this.addConnectionNodeToScene(n,this.layerId,Ae),this.invalidateScene())}}},{key:"invalidateScene",value:function(){r.a.bus.emit("PcbEngine:invalidate")}}])&&xe(t.prototype,n),a&&xe(t,a),Object.defineProperty(t,"prototype",{writable:!1}),e}(),_e=n(32);!function(e){e[e.Voltage=0]="Voltage",e[e.Density=1]="Density"}(Te||(Te={}));var Be=n(221),Fe=n(131),He=n(132),Ge=n(245);function Ke(e){return(Ke="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Ue(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function We(){return(We="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=ze(e,t);if(r){var i=Object.getOwnPropertyDescriptor(r,t);return i.get?i.get.call(arguments.length<3?e:n):i.value}}).apply(this,arguments)}function ze(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=$e(e)););return e}function Qe(e,t){return(Qe=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function Ze(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=$e(e);if(t){var i=$e(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return Xe(this,n)}}function Xe(e,t){if(t&&("object"===Ke(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return qe(e)}function qe(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function $e(e){return($e=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function Ye(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var Je=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&Qe(e,t)}(a,e);var t,n,r,i=Ze(a);function a(e,t,n){var r;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,a);var o=[new He.a([255,255,255,255],0,!1,!1,!1)];return Ye(qe(r=i.call(this,e,[],o,void 0,void 0,t,n)),"activeMeshId",void 0),Ye(qe(r),"activeNodeItem",void 0),r.activeNodeItem=null,r.renderPath=r.scene.CreateRenderPath(),r.logger.LogInfo("Simulation scene successfully initialized."),r}return t=a,(n=[{key:"clear",value:function(){this.tryClear()}},{key:"getZoom",value:function(){return this.viewport.GetZoom()}},{key:"render",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];e&&this.clear(),this.renderScene()}},{key:"renderScene",value:function(){this.beforeRender.emit(this);var e=this.renderPath;this.cameraController.UpdateAnimation(),e.BeginRender()&&(e.SelectViewport2D(this.viewport),e.Render(this.rootNode),e.EndRender(),this.rendered.emit(this))}},{key:"setCenterOffset",value:function(e,t){this.viewport.SetCenter(this.viewportCenter)}},{key:"setSelection",value:function(e){}},{key:"setZoom",value:function(e){e=this.defZoom/e,this.viewportZoom_=e,this.viewport.SetZoom(e)}},{key:"zoomToFit",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:.8,r=n,i=this.renderOptions.filter((function(e){return e.layerName!==B.a.HighlightLayerName})).map((function(e){return e.layer})),a=i.length>0?i:this.layers.map((function(e){return e.index})),o=this.rootNode.GetBoxForLayers(a);null==e&&(e=[o[0],o[1],o[2]]),null==t&&(t=[o[3],o[4],o[5]]),this.viewport.FitFixedView(e,t,r),this.viewport.SetZoom(this.viewportZoom)}},{key:"setFitFixedView",value:function(e,t,n){if(n||(n=.8),null==e||null==t){var r=this.renderOptions.map((function(e){return e.layer})),i=this.rootNode.GetBoxForLayers(r);null==e&&(e=[i[0],i[1],i[2]]),null==t&&(t=[i[3],i[4],i[5]])}this.viewport.FitFixedView(e,t,n)}},{key:"updateSimulationMesh",value:function(e){this.tryClear();var t=We($e(a.prototype),"addMesh",this).call(this,e);this.activeMeshId=t;var n=new Be.b(t,0,0,[0,0,0],[0,0,1],[1,1,1]);delete n.matrix,this.activeNodeItem=this.rootNode.AddItem(new Ge.a([],[n]))}},{key:"viewportToWorld",value:function(e){return this.viewport.ViewportToWorld(e)}},{key:"tryClear",value:function(){return!!this.activeMeshId&&(this.rootNode.DeleteItem(this.activeNodeItem),this.scene.DeleteMesh(this.activeMeshId),this.activeMeshId=void 0,this.activeNodeItem=null,!0)}}])&&Ue(t.prototype,n),r&&Ue(t,r),Object.defineProperty(t,"prototype",{writable:!1}),a}(Fe.a),et=n(173);function tt(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function nt(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var rt=function(){function e(t,n,r,i,a){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.baseScene=t,this.beforeRenderEvent=n,this.renderEvent=r,this.simulation=i,this.selectionManager=a,nt(this,"beforeRenderHandler",void 0),nt(this,"renderHandler",void 0),nt(this,"subscribed",void 0),nt(this,"grayMaterials",void 0),nt(this,"grayMaterialsApplied",void 0),nt(this,"materials",void 0),this.beforeRenderHandler=this.onBeforeRender.bind(this),this.renderHandler=this.onRender.bind(this),this.grayMaterialsApplied=!1,this.subscribed=!1}var t,n,r;return t=e,(n=[{key:"deactivate",value:function(){this.setNormalMaterials()}},{key:"setNormalMaterials",value:function(){this.grayMaterialsApplied&&this.materials&&(this.baseScene.setMaterials(this.materials),this.grayMaterialsApplied=!1,this.baseScene.setDirty(!0))}},{key:"startRendering",value:function(){this.subscribed||(this.subscribed=!0,this.beforeRenderEvent.on(this.beforeRenderHandler),this.renderEvent.on(this.renderHandler))}},{key:"stopRendering",value:function(){this.subscribed&&(this.subscribed=!1,this.beforeRenderEvent.off(this.beforeRenderHandler),this.renderEvent.off(this.renderHandler))}},{key:"copyMaterials",value:function(){this.grayMaterials||(this.materials=this.baseScene.getMaterials(),this.grayMaterials=this.toGrayscaleMaterials(this.materials))}},{key:"onBeforeRender",value:function(){this.copyMaterials(),this.setGrayMaterials()}},{key:"onRender",value:function(){this.simulation.render(!1)}},{key:"setGrayMaterials",value:function(){this.subscribed&&!this.grayMaterialsApplied&&this.grayMaterials&&(this.baseScene.setMaterials(this.grayMaterials),this.grayMaterialsApplied=!0,this.baseScene.setDirty(!0))}},{key:"toGrayscaleMaterials",value:function(e){return e.map((function(e){var t=et.a.toGrayscale(e.Diffuse);return new He.a(t,e.Hatching,e.Bordered,!1,!0)}))}}])&&tt(t.prototype,n),r&&tt(t,r),Object.defineProperty(t,"prototype",{writable:!1}),e}(),it=n(220),at=n(203);function ot(e){return(ot="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function st(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function ct(){return(ct="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=ut(e,t);if(r){var i=Object.getOwnPropertyDescriptor(r,t);return i.get?i.get.call(arguments.length<3?e:n):i.value}}).apply(this,arguments)}function ut(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=pt(e)););return e}function lt(e,t){return(lt=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function dt(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=pt(e);if(t){var i=pt(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return ft(this,n)}}function ft(e,t){if(t&&("object"===ot(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return ht(e)}function ht(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function pt(e){return(pt=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function yt(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var vt=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&lt(e,t)}(a,e);var t,n,r,i=dt(a);function a(e,t,n){var r;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,a);var o=[new He.a([255,255,255,255],0,!1,!1,!1)];return yt(ht(r=i.call(this,e,[],o,void 0,void 0,t,n)),"activeMeshId",void 0),yt(ht(r),"activeNodeItem",void 0),yt(ht(r),"_viewportOffset",void 0),yt(ht(r),"rotationSensitivity",void 0),yt(ht(r),"viewportQuat",void 0),yt(ht(r),"viewportAt",void 0),yt(ht(r),"viewportNear",void 0),yt(ht(r),"viewportFar",void 0),r.activeNodeItem=null,r.renderPath=r.scene.CreateRenderPath(),r.rotationSensitivity=.005*Math.PI,r.viewportAt=window.vec3.create(),r.viewportNear=1.2,r.viewportFar=700,r._viewportOffset=10,r.viewportQuat=window.quat.create(),r.updatePerspectiveMatrix(),r.setZoom(.4),r.logger.LogInfo("Simulation scene successfully initialized."),r}return t=a,(n=[{key:"viewportOffset",set:function(e){this._viewportOffset=e}},{key:"clear",value:function(){this.tryClear()}},{key:"getZoom",value:function(){return this._viewportOffset}},{key:"render",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];e&&this.clear(),this.renderScene()}},{key:"renderScene",value:function(){this.beforeRender.emit(this);var e=this.renderPath;this.cameraController.UpdateAnimation(),e.BeginRender()&&(e.SelectViewport(this.viewport),e.Render(this.rootNode),e.EndRender(),this.rendered.emit(this))}},{key:"setCenterOffset",value:function(e,t){var n=window.vec2,r=window.vec3,i=window.quat,a=n.fromValues(e,t),o=n.scale(n.create(),a,this.rotationSensitivity),s=r.transformQuat(r.create(),r.fromValues(0,1,0),this.viewportQuat);r.normalize(s,s);var c=i.setAxisAngle(i.create(),s,o[0]);i.mul(this.viewportQuat,c,this.viewportQuat);var u=r.transformQuat(r.create(),r.fromValues(1,0,0),this.viewportQuat);r.normalize(u,u);var l=i.setAxisAngle(i.create(),u,o[1]);i.mul(this.viewportQuat,l,this.viewportQuat),this.updateViewMatrix(),this.centerChanged.emit(new it.a(e,t))}},{key:"setSelection",value:function(e){}},{key:"setZoom",value:function(e){e=this.defZoom/e,this._viewportOffset=e,this.updateViewMatrix()}},{key:"zoomToFit",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:.8,r=.8;if(null==e||null==t){var i=this.getRenderLayers(),a=this.rootNode.GetBoxForLayers(i);null==e&&(e=[a[0],a[1],a[2]]),null==t&&(t=[a[3],a[4],a[5]])}if(1!=n){n/=this.getRelativeAspect(e,t);var o=[t[0]-e[0],t[1]-e[1],t[2]-e[2]],s=(o[0]/n-o[0])/2,c=(o[1]/n-o[1])/2,u=(o[2]/n-o[2])/2;e=[e[0]-s,e[1]-c,e[2]-u],t=[t[0]+s,t[1]+c,t[2]+u]}this.fitFixedView_={boxMin:e,boxMax:t,fixedScale:r},this.viewport.FitFixedView(e,t,r),this.zoomToFitChanged.emit(new Fe.b(e,t))}},{key:"setFitFixedView",value:function(e,t,n){if(n||(n=.8),null==e||null==t){var r=this.renderOptions.map((function(e){return e.layer})),i=this.rootNode.GetBoxForLayers(r);null==e&&(e=[i[0],i[1],i[2]]),null==t&&(t=[i[3],i[4],i[5]])}this.viewport.FitFixedView(e,t,n)}},{key:"updateSimulationMesh",value:function(e){this.tryClear();var t=ct(pt(a.prototype),"addMesh",this).call(this,e);this.activeMeshId=t;var n=new Be.b(t,0,0,[0,0,0],[0,0,1],[1,1,1]);delete n.matrix,this.activeNodeItem=this.rootNode.AddItem(new Ge.a([],[n]))}},{key:"tryClear",value:function(){return!!this.activeMeshId&&(this.rootNode.DeleteItem(this.activeNodeItem),this.scene.DeleteMesh(this.activeMeshId),this.activeMeshId=void 0,this.activeNodeItem=null,!0)}},{key:"getRenderLayers",value:function(){var e={};return this.layers.forEach((function(t,n){return e[n]=t.show3d})),this.renderOptions.filter((function(t){return e[t.layer]})).map((function(e){return e.layer}))}},{key:"updateViewMatrix",value:function(){var e=window.vec3,t=e.transformQuat([0,0,0],[0,0,1],this.viewportQuat);e.scale(t,t,this._viewportOffset);var n=this.viewportAt,r=e.transformQuat([0,0,0],[0,1,0],this.viewportQuat),i=e.sub([0,0,0],n,t);this.viewport.ViewSetLookAt(i,n,r)}},{key:"updatePerspectiveMatrix",value:function(){var e=at.a.ViewportFov*Math.PI/180,t=this.canvasWidth/this.canvasHeight;this.viewport.ProjectionSetPerspective(e,t,this.viewportNear,this.viewportFar),this.scene.Resize(this.canvasWidth,this.canvasHeight)}},{key:"getRelativeAspect",value:function(e,t){var n=window.vec2,r=n.sub([0,0],t,e);n.scale(r,r,.5);var i=this.viewport.GetRectangle(),a=r[0]/r[1],o=i[2]/i[3],s=a>o?a/o*1.2:1;return s>2&&(s=1),s}}])&&st(t.prototype,n),r&&st(t,r),Object.defineProperty(t,"prototype",{writable:!1}),a}(Fe.a),mt=n(76),gt=n(9),bt=n(37),wt=n(507),kt=n.n(wt);function St(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null==n)return;var r,i,a=[],o=!0,s=!1;try{for(n=n.call(e);!(o=(r=n.next()).done)&&(a.push(r.value),!t||a.length!==t);o=!0);}catch(e){s=!0,i=e}finally{try{o||null==n.return||n.return()}finally{if(s)throw i}}return a}(e,t)||Ot(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function Pt(e){return(Pt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Lt(e){return function(e){if(Array.isArray(e))return Et(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||Ot(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function Ot(e,t){if(e){if("string"==typeof e)return Et(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?Et(e,t):void 0}}function Et(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function Mt(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Dt(e,t){return(Dt=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function Rt(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=Ct(e);if(t){var i=Ct(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return It(this,n)}}function It(e,t){if(t&&("object"===Pt(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return Nt(e)}function Nt(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function Ct(e){return(Ct=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function xt(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var jt=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&Dt(e,t)}(a,e);var t,n,r,i=Rt(a);function a(e,t){var n;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,a),(n=i.call(this)).logger=e,n.apiHeaders=t,xt(Nt(n),"probeEnabled",void 0),xt(Nt(n),"cache",void 0),xt(Nt(n),"canvasControl",void 0),xt(Nt(n),"currentNet",void 0),xt(Nt(n),"currentLayer",void 0),xt(Nt(n),"currentRenderMesh",void 0),xt(Nt(n),"currentRenderMode",void 0),xt(Nt(n),"currentSimulationMesh",void 0),xt(Nt(n),"currentViewType",void 0),xt(Nt(n),"isSimulationEnabled",void 0),xt(Nt(n),"heightOffset",void 0),xt(Nt(n),"pcbOriginPoint",void 0),xt(Nt(n),"originPoint",void 0),xt(Nt(n),"scene2D",void 0),xt(Nt(n),"scene3D",void 0),n.cache={},n.currentViewType=Te.Voltage,n.isSimulationEnabled=!1,n.probeEnabled=!1,n}return t=a,(n=[{key:"simulationEnabled",get:function(){return this.isSimulationEnabled}},{key:"createSimulationScene2d",value:function(e,t){if(this.scene2D)return this.scene2D.simulation;var n=new Je(null,e,"PCB_2D_Simulation_Scene");return this.scene2D=new rt(e,e.beforeRender,e.rendered,n,t),this.tryShowSimulation(),n}},{key:"createSimulationScene3d",value:function(e,t){if(this.scene3D)return this.scene3D.simulation;var n=new vt(null,e,"PCB_3D_Simulation_Scene");return this.scene3D=new rt(e,e.beforeRender,e.rendered,n,t),this.tryShowSimulation(),n}},{key:"changeRenderMode",value:function(e){var t,n,r,i;if(this.currentRenderMode&&this.currentRenderMode!==e){switch(e){case mt.a.Render2D:null===(t=this.scene3D)||void 0===t||t.setNormalMaterials(),null===(n=this.scene2D)||void 0===n||n.baseScene.render(!1);break;case mt.a.Render3D:null===(r=this.scene2D)||void 0===r||r.setNormalMaterials(),null===(i=this.scene3D)||void 0===i||i.baseScene.render(!1)}this.currentRenderMode=e}else this.currentRenderMode=e}},{key:"handleOutdatedSimulation",value:function(e){var t=this,n=e.notificationComponent,r=n.instance;this.heightOffset=function(){return r.$el.offsetHeight},n.onClose((function(){t.heightOffset=void 0}))}},{key:"getSimulationValue2d",value:function(e){if(!this.probeEnabled)return null;if(this.heightOffset){var t=this.heightOffset();e=[e[0],e[1]-t]}var n=this.scene2D,r=this.currentSimulationMesh;if(!n||!r)return null;var i=n.simulation.viewportToWorld(e),a=this.getValueAtXY(r,i);return a?{x:e[0],y:e[1],value:a,units:this.getSimulationUnits()}:null}},{key:"getUniqueLayerNames",value:function(e){var t=e.Meshes.map((function(e){return e.Layer}));return Lt(new Set(t))}},{key:"getUniqueNetNames",value:function(e){var t=e.Meshes.map((function(e){return e.Net}));return Lt(new Set(t))}},{key:"hideSimulation",value:function(){var e,t=this.scene3D;t&&(t.stopRendering(),t.simulation.clear(),t.setNormalMaterials(),this.currentRenderMode==mt.a.Render3D&&t.baseScene.render(!1));var n=this.scene2D;n&&(n.stopRendering(),n.simulation.clear(),n.setNormalMaterials(),this.currentRenderMode==mt.a.Render2D&&n.baseScene.render(!1)),null===(e=this.canvasControl)||void 0===e||e.invalidate(),this.isSimulationEnabled=!1}},{key:"loadSimulationData",value:function(e){var t=this;return this.logger.LogDebug("Load document PDN simulation: ".concat(e)),new Promise((function(n,r){fetch(e,{method:"GET",headers:t.apiHeaders}).then((function(e){if(!e.ok)throw new Error("Document simulation loading error. [".concat(e.statusText,"]"));return e.json()})).then((function(r){if(!r||"object"!==Pt(r))throw new Error("Simulation PDN data is wrong");r.BoardOriginX?(r.BoardOriginX=0,r.BoardOriginY=0,r.useOriginPoint=!0):r.useOriginPoint=!1,t.logger.LogDebug("Success load document PDN simulation: ".concat(e)),r.kind="PDNAnalyzer",n(r)})).catch((function(e){return r(e)}))}))}},{key:"loadSimulationAnsysData",value:function(e){var t=this;return this.logger.LogDebug("Load Ansys document with simulation: ".concat(e)),new Promise((function(n,r){fetch(e,{method:"GET",headers:t.apiHeaders}).then((function(e){if(!e.ok)throw new Error("Ansys document with simulation loading error. [".concat(e.statusText,"]"));return e.blob()})).then(kt.a.loadAsync).then((function(e){for(var t in e.files)if(t.endsWith(".json"))return e.file(t).async("string");throw new Error("Not found json file with simulation data in Ansys document")})).then((function(r){var i=JSON.parse(r);if(!i||"object"!==Pt(i))throw new Error("Simulation data is wrong");i.BoardOriginX?(i.BoardOriginX=0,i.BoardOriginY=0,i.useOriginPoint=!0):i.useOriginPoint=!1,t.logger.LogDebug("Success load document simulation: ".concat(e)),i.kind="Signal Integrity",n(i)})).catch((function(e){return r(e)}))}))}},{key:"showSimulationData",value:function(e,t,n,r){this.isSimulationEnabled=!0,n||(n=this.currentNet?this.currentNet:this.getUniqueNetNames(e)[0]),r=r?r.toUpperCase().replace(" ","_"):this.currentLayer?this.currentLayer:this.getUniqueLayerNames(e)[0],this.currentNet=n,this.currentLayer=r;var i="".concat(t,"-{layerName}-").concat(n,"-").concat(this.currentViewType),a=this.cache[i],o=e.Meshes.find((function(e){return e.Net===n&&e.Layer===r}));if(!o)return this.currentRenderMesh=void 0,void this.clearSimulationMesh();e.useOriginPoint?this.overrideOriginPoint(e.BoardOriginX,e.BoardOriginY):this.restoreOriginPoint(),a||(a=this.buildRenderMesh(o),this.cache[i]=a),this.currentRenderMesh=a,this.currentSimulationMesh=o,this.tryShowSimulation()}},{key:"selectSimulationViewOption",value:function(e){switch(e){case"Voltage":this.currentViewType=Te.Voltage;break;case"Current Density":this.currentViewType=Te.Density;break;default:throw new Error("Simulation view option ".concat(e," is not supported"))}return!0}},{key:"startRendering",value:function(){this.scene2D&&this.scene2D.startRendering(),this.scene3D&&this.scene3D.startRendering()}},{key:"useOriginPoint",value:function(e,t){this.pcbOriginPoint=[e,t,0],this.originPoint=this.convertToInches(this.pcbOriginPoint)}},{key:"useCanvasControl",value:function(e){this.canvasControl=e}},{key:"buildRenderMesh",value:function(e){for(var t,n=[],r=e.Patches,i=0;i<r.length;i++){var a=r[i];n.push(a[0]-1),n.push(a[1]-1),n.push(a[2]-1)}for(var o=St(null!==(t=this.originPoint)&&void 0!==t?t:[0,0,0],3),s=o[0],c=o[1],u=o[2],l=St(this.getMeshValueRange(e),2),d=l[0],f=l[1],h=e.Vertices,p=this.getSimulationDrawData(e),y=[0,0,-1],v=[],m=0;m<h.length;m++){var g=this.convertToInches(h[m]);v[m]=new Be.c([g[0]+s,g[1]+c,g[2]+u],y,this.buildColor(p[m],d,f))}return new Be.a(v,n)}},{key:"buildColor",value:function(e,t,n){var r=this.logNormalize(e,t,n),i=1;r<0?(r=0,i=0):r>1&&(r=1,i=0);var a=.66*(1-r);return this.convertHsvToRgb(a,1,1,i)}},{key:"clearSimulationMesh",value:function(){var e=this.scene2D;e&&e.simulation.clear();var t=this.scene3D;t&&t.simulation.clear()}},{key:"convertToInches",value:function(e){return[1e-6*e[0],1e-6*e[1],1e-6*e[2]]}},{key:"convertHsvToRgb",value:function(e,t,n,r){var i=0,a=0,o=0,s=Math.floor(6*e),c=6*e-s,u=n*(1-t),l=n*(1-c*t),d=n*(1-(1-c)*t);switch(s%6){case 0:i=n,a=d,o=u;break;case 1:i=l,a=n,o=u;break;case 2:i=u,a=n,o=d;break;case 3:i=u,a=l,o=n;break;case 4:i=d,a=u,o=n;break;case 5:i=n,a=u,o=l}return[Math.round(255*i),Math.round(255*a),Math.round(255*o),Math.round(255*r)]}},{key:"getValueAtXY",value:function(e,t){for(var n,r=St(null!==(n=this.originPoint)&&void 0!==n?n:[0,0,0],3),i=r[0],a=r[1],o=r[2],s=e.Patches,c=this.getSimulationDrawData(e),u=e.Vertices,l=0;l<s.length;l++){var d=s[l],f=d[0]-1,h=d[1]-1,p=d[2]-1,y=this.convertToInches(u[f]),v=this.convertToInches(u[h]),m=this.convertToInches(u[p]),g=this.ptInTriangle_UVW(t,[y[0]+i,y[1]+a,y[2]+o],[v[0]+i,v[1]+a,v[2]+o],[m[0]+i,m[1]+a,m[2]+o]);if(g)return c[f]*g[0]+c[h]*g[1]+c[p]*g[2]}}},{key:"getMeshValueRange",value:function(e){for(var t=1e9,n=-1e9,r=this.getSimulationDrawData(e),i=0;i<r.length;i++){var a=r[i];a<t&&(t=a),a>n&&(n=a)}return t===n&&(n+=1),[t,n]}},{key:"getSimulationDrawData",value:function(e){switch(this.currentViewType?this.currentViewType:Te.Voltage){case Te.Voltage:return e.Voltage;case Te.Density:return e.CurrentDensity}}},{key:"getSimulationUnits",value:function(){switch(this.currentViewType?this.currentViewType:Te.Voltage){case Te.Voltage:return gt.l.voltage;case Te.Density:return gt.l.currentDensity}}},{key:"overrideOriginPoint",value:function(e,t){this.originPoint=this.convertToInches([e,t,0])}},{key:"linearNormalize",value:function(e,t,n){return n-t<5e-324?1:(e-t)/(n-t)}},{key:"logNormalize",value:function(e,t,n){return n-t<5e-324?1:n-t<1e3?this.linearNormalize(e,t,n):(t<0&&(e+=-t,n+=-t,t=0),t<1&&(e+=1,t+=1,n+=1),(Math.log10(e)-Math.log10(t))/(Math.log10(n)-Math.log10(t)))}},{key:"ptInTriangle_UVW",value:function(e,t,n,r){var i=t[0],a=t[1],o=n[0]-i,s=n[1]-a,c=r[0]-i,u=r[1]-a,l=e[0]-i,d=e[1]-a,f=o*u-c*s;if(0==f)return[];var h=(l*u-c*d)/f;if(!(h<0||h>1)){var p=(o*d-l*s)/f;if(!(p<0||p>1)){var y=1-h-p;if(!(y<0||y>1))return[y,h,p]}}}},{key:"restoreOriginPoint",value:function(){this.pcbOriginPoint?this.originPoint=this.convertToInches([this.pcbOriginPoint[0],this.pcbOriginPoint[1],0]):this.originPoint=this.convertToInches([0,0,0])}},{key:"tryShowSimulation",value:function(){var e,t=this.currentRenderMesh;if(!t)return!1;var n=this.scene2D;n&&(n.selectionManager.clearSelection(!1),n.simulation.updateSimulationMesh(t));var r=this.scene3D;return r&&(r.selectionManager.clearSelection(!1),r.simulation.updateSimulationMesh(t)),null===(e=this.canvasControl)||void 0===e||e.invalidate(),this.emit("SHOW"),!0}}])&&Mt(t.prototype,n),r&&Mt(t,r),Object.defineProperty(t,"prototype",{writable:!1}),a}(bt.a);function Tt(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return At(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return At(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,o=!0,s=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return o=e.done,e},e:function(e){s=!0,a=e},f:function(){try{o||null==n.return||n.return()}finally{if(s)throw a}}}}function At(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function Vt(e,t,n,r,i,a,o){try{var s=e[a](o),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,i)}function _t(e){return function(){var t=this,n=arguments;return new Promise((function(r,i){var a=e.apply(t,n);function o(e){Vt(a,r,i,o,s,"next",e)}function s(e){Vt(a,r,i,o,s,"throw",e)}o(void 0)}))}}function Bt(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Ft(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var Ht=function(){function e(){var t=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),Ft(this,"currentDocumentIndex",0),Ft(this,"currentSimulationType",void 0),Ft(this,"documents",[]),Ft(this,"logger",r.a.createLogger("PcbEngine")),Ft(this,"metadata",void 0),Ft(this,"layerFactory",void 0),Ft(this,"layerManager_",void 0),Ft(this,"canvasControl",void 0),Ft(this,"pcbRenderer",void 0),Ft(this,"pcbLoaded",void 0),Ft(this,"controlDiv",void 0),Ft(this,"selectionNodesObserver",void 0),Ft(this,"selectionItemsObserver",void 0),Ft(this,"engineFsm",void 0),Ft(this,"padAppearanceManager",void 0),Ft(this,"simulationManager",void 0),this.engineFsm=new b(this),this.layerFactory=new Re,this.pcbLoaded=!1,this.simulationManager=new jt(this.logger,r.a.apiHeaders),this.engineFsm.on("SETUP",(function(){return t.logger.LogDebug(t.engineFsm.getState())})),this.engineFsm.on("SETUP_COMPLETED",(function(){return t.logger.LogDebug(t.engineFsm.getState())})),this.engineFsm.on("INIT",(function(){return t.logger.LogDebug(t.engineFsm.getState())})),this.engineFsm.on("INIT_COMPLETED",(function(){return t.logger.LogDebug(t.engineFsm.getState())})),this.engineFsm.on("RENDER",(function(){return t.logger.LogDebug(t.engineFsm.getState())})),this.engineFsm.on("RENDER_COMPLETED",(function(){return t.logger.LogDebug(t.engineFsm.getState())})),this.engineFsm.on("CRASHED",(function(e){var n,r,i;return t.logger.LogDebug(t.engineFsm.getState()+" with error "+(null!==(n=null!==(r=null===(i=e.error)||void 0===i?void 0:i.message)&&void 0!==r?r:e.error)&&void 0!==n?n:e))})),this.engineFsm.on("SHOW",(function(e){return t.logger.LogDebug(t.engineFsm.getState()+" for render mode "+e.renderMode)})),this.selectionItemsObserver=new w.e}var t,n,a,o,s,c,u,l;return t=e,(n=[{key:"setup",value:function(e){return this.engineFsm.goToSetup(e)}},{key:"name",get:function(){return"PcbEngine"}},{key:"comment",get:function(){return"PCB documents handler engine"}},{key:"dependencies",get:function(){return["graphite.engine"]}},{key:"metaInfo",get:function(){return this}},{key:"events",get:function(){return["PcbEngine:didDocumentAttach","PcbEngine:didDocumentDettach","PcbEngine:didDocumentAttachError","PcbEngine:beforeDocumentInit","PcbEngine:afterDocumentInit","PcbEngine:beforeImportPCB","PcbEngine:afterImportPCB","LayerManager:changedLayers","PcbEngine:flipped","PcbEngine:layerManagerCreated","PcbEngine:select","PcbEngine:clearSelection","PcbEngine:selectNodes","PcbEngine:highlightNodes","PcbEngine:highlight","PcbEngine:willMeasure","PcbEngine:didMeasure","PcbEngine:cancelMeasure","PcbEngine:measuring","PcbEngine:documents","PcbEngine:documentChanged","PcbEngine:showDocument","PcbEngine:enableSelection","PcbEngine:rendererCreated","PcbEngine:setPadAppearance","PcbEngine:clearPadAppearance","PcbEngine:initScenes","PcbEngine:changedRenderMode","PcbEngine:invalidate","PcbEngine:fps","PcbEngine:simulationLoaded","PcbEngine:simulationMouseData","PcbEngine:renderTime","PcbEngine:documentMove","PcbEngine:documentZoom","PcbEngine:resetDocumentView","PcbEngine:documentClick"]}},{key:"activeDocumentIndex",get:function(){return this.currentDocumentIndex}},{key:"allDocuments",get:function(){return this.documents}},{key:"layerManager",get:function(){return this.layerManager_}},{key:"activeDocument",get:function(){var e;return null!==(e=this.documents)&&void 0!==e&&e.length||this.currentDocumentIndex>this.documents.length?null:this.documents[this.currentDocumentIndex]}},{key:"changeProbeState",value:function(e){this.simulationManager.probeEnabled=e}},{key:"init",value:(l=_t(regeneratorRuntime.mark((function e(){var t;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=this.documents[0],e.next=3,this.engineFsm.goToInit(t);case 3:return e.next=5,this.engineFsm.goToRender(t);case 5:case"end":return e.stop()}}),e,this)}))),function(){return l.apply(this,arguments)})},{key:"showView",value:(u=_t(regeneratorRuntime.mark((function e(t,n){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.engineFsm.goToShow(t,n);case 2:case"end":return e.stop()}}),e,this)}))),function(e,t){return u.apply(this,arguments)})},{key:"handleOutdatedSimulation",value:function(e){this.simulationManager.handleOutdatedSimulation(e)}},{key:"hideView",value:function(){this.canvasControl&&this.canvasControl.peformanceMonitor.stopFpsMeter()}},{key:"resetView",value:function(){this.pcbRenderer&&(this.pcbRenderer.zoomToFit(500),this.canvasControl.invalidate(),r.a.bus.emit("PcbEngine:resetDocumentView",{type:"reset"}))}},{key:"doSetup",value:function(e){var t=this,n=e.response;if(!n)throw this.logger.LogError("Response is empty."),new Error("Response is empty.");this.onCreatedScene2D=this.onCreatedScene2D.bind(this),this.setupMetadata(n),r.a.bus.once("GraphiteEngine:createdScene2D",this.onCreatedScene2D),r.a.bus.on("PcbEngine:initScenes",(function(e,n,r){return t.addUnroutedNets(e,r)})),r.a.bus.on("PcbEngine:initScenes",(function(e,n,r){return t.initPadAppearanceManager(e,n,r)})),r.a.bus.on("PcbEngine:setPadAppearance",(function(e){return t.setPadAppearance(e)})),r.a.bus.on("PcbEngine:clearPadAppearance",(function(){return t.clearPadAppearance()})),r.a.bus.on("PcbEngine:invalidate",(function(){return t.canvasControl.invalidate()})),this.onStorageRefresh=this.onStorageRefresh.bind(this),r.a.bus.on("storageRefreshComplete",this.onStorageRefresh),this.setupDocuments(n)}},{key:"doInit",value:(c=_t(regeneratorRuntime.mark((function e(t){var n,a;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return Object(Ie.a)(),n="Load document error.",e.prev=2,a=new i.LibraryLoader,e.next=6,a.loadLibs();case 6:return e.next=8,this.resolveGraphite();case 8:return e.next=10,this.loadDocument(t);case 10:try{r.a.bus.emit("PcbEngine:documentChanged",t)}catch(e){this.logger.LogError("PcbEngine:documentChanged emit error. "+e.message)}e.next=21;break;case 13:if(e.prev=13,e.t0=e.catch(2),this.logger.LogError(n,e.t0),!(e.t0 instanceof _e.d)){e.next=20;break}throw e.t0;case 20:throw new Error(n);case 21:case"end":return e.stop()}}),e,this,[[2,13]])}))),function(e){return c.apply(this,arguments)})},{key:"doRender",value:function(e){try{this.canvasControl.loadData(e.renderData,this.metadata.projectTypeName),r.a.bus.emit("PcbEngine:didDocumentAttach",e.id)}catch(e){throw"string"==typeof e?this.logger.LogError(e):this.logger.LogError("Error ".concat(e.name,": ").concat(e.message,"\n").concat(e.stack)),r.a.bus.emit("PcbEngine:didDocumentAttachError",e),new Error("Render document error.")}}},{key:"doShow",value:function(e,t){var n,r,i=this.canvasControl.getContainerId(),a=document.getElementById(i);if(!a)throw new Error("Paint has not found.");e.appendChild(a),this.pcbRenderer.renderMode=t,null===(n=this.selectionItemsObserver)||void 0===n||n.setRenderMode(t),null===(r=this.selectionNodesObserver)||void 0===r||r.setRenderMode(t),this.canvasControl.onResize(),this.canvasControl.invalidate(),this.canvasControl.peformanceMonitor.startFpsMeter(1e3),this.pcbLoaded=!0,this.simulationManager.simulationEnabled&&this.showSimulation()}},{key:"hideSimulation",value:function(){var e,t=null===(e=this.documents[0])||void 0===e?void 0:e.simulation;t&&!t.loading&&t.items.some((function(e){return e.data}))&&t.shown&&(this.simulationManager.hideSimulation(),r.a.bus.emit("select",null),r.a.bus.emit("PcbEngine:enableSelection",!0),this.logger.LogDebug("Simulation hidden"),t.shown=!1)}},{key:"loadSimulation",value:(s=_t(regeneratorRuntime.mark((function e(t){var n,i,a,o,s,c,u,l;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=this.documents[0]){e.next=4;break}return this.logger.LogDebug("Simulation won't load - no document"),e.abrupt("return",Promise.resolve(!1));case 4:if((i=n.simulation)||(i={items:t,loading:!1,shown:!1,loaded:!1},n.simulation=i),!i.loading){e.next=9;break}return this.logger.LogDebug("Simulation is already loading"),e.abrupt("return",Promise.resolve(!1));case 9:if(!i.loaded){e.next=12;break}return this.logger.LogDebug("Simulation loaded"),e.abrupt("return",Promise.resolve(!0));case 12:this.logger.LogDebug("Start loading simulation data..."),i.loading=!0,a=this.simulationManager,o=Tt(i.items),e.prev=16,o.s();case 18:if((s=o.n()).done){e.next=44;break}if((c=s.value).url){e.next=23;break}return this.logger.LogDebug("".concat(c.type," document is not present")),e.abrupt("continue",42);case 23:u=void 0,e.t0=c.type.toLowerCase(),e.next=e.t0==="AnsysEDB".toLowerCase()||e.t0==="Signal Integrity".toLowerCase()?27:e.t0==="PDNAnalyzer".toLowerCase()?31:35;break;case 27:return e.next=29,a.loadSimulationAnsysData(c.url);case 29:return u=e.sent,e.abrupt("break",37);case 31:return e.next=33,a.loadSimulationData(c.url);case 33:return u=e.sent,e.abrupt("break",37);case 35:return this.logger.LogWarn("Unsupported type of simulation ".concat(c.type)),e.abrupt("break",37);case 37:if(u){e.next=39;break}return e.abrupt("continue",42);case 39:c.data=u,l=a.getUniqueNetNames(u),r.a.bus.emit("PcbEngine:simulationLoaded",{kind:c.data.kind,type:c.type,data:u,nets:l,url:c.url});case 42:e.next=18;break;case 44:e.next=49;break;case 46:e.prev=46,e.t1=e.catch(16),o.e(e.t1);case 49:return e.prev=49,o.f(),e.finish(49);case 52:return i.loading=!1,i.loaded=!0,this.logger.LogDebug("Simulation data loaded"),e.abrupt("return",!0);case 56:case"end":return e.stop()}}),e,this,[[16,46,49,52]])}))),function(e){return s.apply(this,arguments)})},{key:"showSimulation",value:function(e,t,n){var i,a=null===(i=this.documents[0])||void 0===i?void 0:i.simulation;if(a&&!a.loading){var o,s,c=a.items;if(!e)if(this.currentSimulationType)e=this.currentSimulationType;else if(!(e=null===(o=c.find((function(e){return e.data})))||void 0===o||null===(s=o.data)||void 0===s?void 0:s.kind))return void this.logger.LogWarn("Default simulation data is not found");this.currentSimulationType=e;var u=c.find((function(t){return t.data&&t.data.kind===e}));u&&u.data?(this.simulationManager.showSimulationData(u.data,e,t,n),a.shown=!0,this.logger.LogDebug("Simulation data added to scene"),this.pcbLoaded?(r.a.bus.emit("select",null),r.a.bus.emit("PcbEngine:enableSelection",!1),this.simulationManager.startRendering()):this.logger.LogDebug("Simulation ready to render, but PCB is not loaded yet")):this.logger.LogWarn("There isn't data for show ".concat(e))}}},{key:"selectSimulationViewOption",value:function(e){this.simulationManager.selectSimulationViewOption(e)&&this.showSimulation()}},{key:"loadDocument",value:(o=_t(regeneratorRuntime.mark((function e(t){var n,i,a;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=r.a.response.storage,!t.errorState){e.next=3;break}return e.abrupt("return");case 3:return e.prev=3,e.next=6,n.documentLoader.loadDocument(t.fileData.originalName,t.fileData.fileType);case 6:return i=e.sent,e.next=9,i.arrayBuffer();case 9:if(a=e.sent,t.isLoaded=!0,t.renderData=a,a){e.next=14;break}throw new Error("Document is empty.");case 14:e.next=20;break;case 16:throw e.prev=16,e.t0=e.catch(3),t.errorState=e.t0,e.t0;case 20:case"end":return e.stop()}}),e,null,[[3,16]])}))),function(e){return o.apply(this,arguments)})},{key:"getBackgroundColor",value:function(){var e,t=null===(e=this.metadata)||void 0===e?void 0:e.projectTypeName,n=function(e){return e=e.map((function(e,t){return t<3?255*e:e})),"rgba(".concat(e.join(","),")")};return n("Eagle"==t||"KiCad"==t?_.b:_.a)}},{key:"resolveGraphite",value:function(){var e=this;return new Promise((function(t,n){(new i.GraphiteResolver).on("COMPLETED",(function(n){e.controlDiv=window.document.createElement("div"),e.controlDiv.style.display="none",window.document.body.appendChild(e.controlDiv),e.canvasControl=new _.c(e.controlDiv,n.payload.graphiteResolver,new w.d,e.getBackgroundColor(),"PCBView",e.simulationManager),e.canvasControl.peformanceMonitor.on("aggregateFps",(function(t){return r.a.bus.emit("PcbEngine:fps",t,e.pcbRenderer.renderMode)})),e.canvasControl.peformanceMonitor.on("renderTime",(function(t,n){return r.a.bus.emit("PcbEngine:renderTime",t,n,e.pcbRenderer.renderMode)})),e.pcbRenderer=e.canvasControl.getRenderer(),e.pcbRenderer.renderModeChanged.on((function(){e.canvasControl&&e.canvasControl.peformanceMonitor.startFpsMeter(1e3)})),e.selectionItemsObserver.setup(e.pcbRenderer),t()})).on("CRASHED",(function(e){return n(e)})).init()}))}},{key:"setupMetadata",value:function(e){this.metadata=e.metadata}},{key:"definePreviewUrlProperty",value:function(e,t,n,r){Object.defineProperty(e,2===r?"previewUrl2D":"previewUrl3D",{get:function(){var e,i;return null!==(e=null===(i=t.files.find((function(e){return"Preview"===e.fileType&&e.originalName===n&&e.dataFileUrl.toLowerCase().includes(2===r?"_2d.png":"_3d.png")})))||void 0===i?void 0:i.dataFileUrl)&&void 0!==e?e:""}})}},{key:"getDocumentsFromStorage",value:function(e){var t=this,n=[];return e&&e.files&&e.files.filter((function(e){return"PcbGraphiteData"===e.fileType})).forEach((function(r,i){var a={id:i.toString(),previewUrl2D:"",previewUrl3D:"",isLoaded:!1,name:r.originalName,displayName:r.originalName,renderData:null,errorState:null,fileData:r};t.definePreviewUrlProperty(a,e,r.originalName,2),t.definePreviewUrlProperty(a,e,r.originalName,3),a.toString=function(){return"[".concat(a.id,"] ").concat(a.name," [").concat(a.isLoaded?"Lodaed":"Not Loaded","]")},n.push(a)})),n}},{key:"setupDocuments",value:function(e){if(!e)throw new Error("Response is empty");var t=this.getDocumentsFromStorage(e.storage);if(0===t.length)throw new Error("No documents to display");var n=e.metadata.pcbDocument;if(e.metadata&&n){this.simulationManager.useOriginPoint(n.originX,n.originY);var r=n.fileName,i=t.find((function(e){return e.name==r}));i?(i.id=n.id?n.id:"DEFAULT",this.documents.push(i)):this.logger.LogWarn("!!!! sortPcbDataByMetadata: ".concat(r))}}},{key:"onCreatedScene2D",value:function(e){var t=this;this.layerFactory&&(this.layerManager_=this.layerFactory.createLayerManager(e),this.layerManager_.resetLayers(),this.selectionNodesObserver=new w.i(this.layerManager_,this.simulationManager),r.a.bus.emit("PcbEngine:layerManagerCreated",this.layerManager_),r.a.bus.on("LayerManager:changedLayers",(function(){return t.canvasControl.invalidate()})),r.a.bus.on("PcbEngine:flipped",(function(){return t.canvasControl.invalidate()})))}},{key:"initPadAppearanceManager",value:function(e,t,n){e&&t&&(this.padAppearanceManager=new V(e,t,n),this.canvasControl.invalidate())}},{key:"setPadAppearance",value:function(e){if(this.padAppearanceManager){var t=performance.now();try{this.padAppearanceManager.clearPadAppearance(),this.padAppearanceManager.setPadAppearance(this.layerManager,e,null),this.canvasControl.invalidate(),this.logger.LogDebug("setPadAppearance "+(performance.now()-t))}catch(e){this.logger.LogError("Set pad appearences.\n Error ".concat(e.name,": ").concat(e.message,"\n").concat(e.stack))}}}},{key:"clearPadAppearance",value:function(){var e;null===(e=this.padAppearanceManager)||void 0===e||e.clearPadAppearance(),this.canvasControl.invalidate()}},{key:"addUnroutedNets",value:function(e,t){var n=this;e&&new Ve(e).addConnectionsToScene(t).then((function(){return n.canvasControl.invalidate()}))}},{key:"onStorageRefresh",value:function(){var e,t=this;this.getDocumentsFromStorage(null===(e=r.a.response)||void 0===e?void 0:e.storage).forEach((function(e){var n=t.documents.find((function(t){return t.name===e.name}));n&&(n.previewUrl2D=e.previewUrl2D,n.previewUrl3D=e.previewUrl3D)}))}}])&&Bt(t.prototype,n),a&&Bt(t,a),Object.defineProperty(t,"prototype",{writable:!1}),e}(),Gt={type:"Engine",name:"PcbEngine",description:"Presents PCB documents engine module",create:function(){return new Ht}};r.a.addModule(Gt)}});